<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Entropy AI - PulseChain Smart Contract Interface</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --bg-card: #16161f;
      --border-color: rgba(255, 255, 255, 0.08);
      --border-hover: rgba(255, 255, 255, 0.15);
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.5;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: var(--accent-gradient);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 700;
    }

    .logo-text {
      font-size: 22px;
      font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .logo-subtitle {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .header-status {
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .status-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .status-badge.connected {
      border-color: var(--success);
      color: var(--success);
    }

    .status-badge.error {
      border-color: var(--error);
      color: var(--error);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: currentColor;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: white;
    }

    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-secondary);
    }

    .btn-secondary:hover {
      border-color: var(--border-hover);
      color: var(--text-primary);
    }

    .btn-success {
      background: linear-gradient(135deg, var(--success), #16a34a);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, var(--warning), #d97706);
      color: white;
    }

    .btn-sm {
      padding: 8px 14px;
      font-size: 12px;
    }

    /* Main Layout */
    .main {
      display: grid;
      grid-template-columns: 280px 1fr 520px;
      gap: 0;
      min-height: calc(100vh - 73px);
    }

    /* Sidebar */
    .sidebar {
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      padding: 20px;
      overflow-y: auto;
    }

    .sidebar-section {
      margin-bottom: 24px;
    }

    .sidebar-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--accent-primary);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .sidebar-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, var(--border-color), transparent);
    }

    /* Input styles */
    .input-group {
      margin-bottom: 12px;
    }

    .input-label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
    }

    .input {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      transition: all 0.2s;
    }

    .input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .input::placeholder {
      color: var(--text-muted);
    }

    .input-with-btn {
      display: flex;
      gap: 8px;
    }

    .input-with-btn .input {
      flex: 1;
    }

    /* Contract List */
    .contract-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .contract-item {
      padding: 10px 12px;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .contract-item:hover {
      border-color: var(--accent-primary);
      background: var(--bg-tertiary);
    }

    .contract-item-name {
      font-size: 13px;
      font-weight: 500;
    }

    .contract-item-addr {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
      color: var(--text-muted);
    }

    .contract-item-type {
      font-size: 10px;
      padding: 2px 8px;
      background: var(--accent-gradient);
      border-radius: 4px;
      color: white;
    }
    
    /* Ecosystem Category Styles */
    .ecosystem-category {
      margin-bottom: 4px;
    }
    
    .category-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
      transition: all 0.2s;
    }
    
    .category-header:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }
    
    .category-arrow {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .category-contracts {
      padding-left: 8px;
      margin-top: 4px;
    }
    
    .category-contracts .contract-item {
      padding: 8px 10px;
      font-size: 12px;
    }
    
    .category-contracts .contract-item-name {
      font-size: 12px;
    }
    
    .category-contracts .contract-item-addr {
      font-size: 9px;
    }

    /* Main Content */
    .content {
      padding: 24px;
      overflow-y: auto;
    }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      margin-bottom: 20px;
      overflow: hidden;
    }

    .card-header {
      padding: 16px 20px;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .card-body {
      padding: 20px;
    }

    /* Contract Info */
    .contract-info {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    .info-item {
      background: var(--bg-primary);
      padding: 14px 16px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .info-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .info-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      color: var(--text-primary);
      word-break: break-all;
    }

    .info-value.large {
      font-size: 18px;
      font-weight: 600;
    }

    /* Function Builder */
    .function-builder {
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 16px;
      border: 1px solid var(--border-color);
    }

    .function-select {
      width: 100%;
      padding: 12px 14px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 16px;
    }

    .function-select:focus {
      outline: none;
      border-color: var(--accent-primary);
    }

    .function-select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .param-inputs {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }

    .param-input {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .param-input label {
      min-width: 120px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .param-input .input {
      flex: 1;
    }

    .param-type {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      color: var(--accent-primary);
      padding: 4px 8px;
      background: rgba(99, 102, 241, 0.1);
      border-radius: 4px;
    }

    .function-actions {
      display: flex;
      gap: 12px;
    }

    .function-actions .btn {
      flex: 1;
    }

    /* Output */
    .output-panel {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }

    .output-panel::-webkit-scrollbar {
      width: 8px;
    }

    .output-panel::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 4px;
    }

    .output-content {
      padding: 16px;
      white-space: pre-wrap;
      word-break: break-all;
      line-height: 1.6;
      color: var(--text-secondary);
    }

    .output-success { color: var(--success); }
    .output-error { color: var(--error); }
    .output-info { color: var(--info); }

    /* AI Panel */
    .ai-panel {
      background: var(--bg-secondary);
      border-left: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      height: calc(100vh - 73px);
    }

    .ai-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
    }

    .ai-title {
      font-size: 16px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .ai-title span {
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .ai-config {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-color);
      background: var(--bg-tertiary);
    }

    .ai-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      background: var(--bg-primary);
    }

    .ai-message {
      margin-bottom: 20px;
      padding: 16px 20px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
    }

    .ai-message.user {
      background: var(--accent-gradient);
      color: white;
      margin-left: 40px;
      border-bottom-right-radius: 4px;
    }

    .ai-message.assistant {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      margin-right: 20px;
      border-bottom-left-radius: 4px;
    }

    .ai-message pre {
      background: var(--bg-secondary);
      padding: 14px;
      border-radius: 8px;
      margin: 14px 0;
      overflow-x: auto;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      border: 1px solid var(--border-color);
    }

    .ai-message code {
      font-family: 'JetBrains Mono', monospace;
      background: var(--bg-secondary);
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--accent-primary);
    }
    
    .ai-message h3, .ai-message h4 {
      margin: 16px 0 8px 0;
      color: var(--accent-primary);
    }
    
    .ai-message ul, .ai-message ol {
      margin: 8px 0;
      padding-left: 20px;
    }
    
    .ai-message li {
      margin: 4px 0;
    }

    .ai-input-container {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .ai-input-wrapper {
      display: flex;
      gap: 12px;
    }

    .ai-input {
      flex: 1;
      padding: 14px 18px;
      background: var(--bg-primary);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
    }

    .ai-input:focus {
      outline: none;
      border-color: var(--accent-primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    
    .ai-input-container {
      padding: 16px 20px;
      border-top: 1px solid var(--border-color);
      background: var(--bg-secondary);
    }

    .ai-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .ai-quick-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .ai-quick-btn {
      padding: 8px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .ai-quick-btn:hover {
      border-color: var(--accent-primary);
      color: var(--accent-primary);
      background: rgba(99, 102, 241, 0.1);
    }
    
    .ai-quick-btn.primary {
      background: var(--accent-gradient);
      color: white;
      border: none;
    }
    
    .ai-quick-btn.primary:hover {
      opacity: 0.9;
      color: white;
    }
    
    /* AI Activity Log */
    .ai-activity-log {
      border-top: 1px solid var(--border-color);
      background: var(--bg-tertiary);
      max-height: 200px;
    }
    
    .ai-activity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
    }
    
    .ai-activity-header:hover {
      background: var(--bg-card);
      color: var(--text-secondary);
    }
    
    .ai-activity-content {
      max-height: 120px;
      overflow-y: auto;
      padding: 0 12px 8px 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px;
    }
    
    .ai-activity-content.collapsed {
      display: none;
    }
    
    .log-entry {
      padding: 3px 0;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-muted);
      font-size: 10px;
    }
    
    .log-entry.success { color: var(--success); }
    .log-entry.error { color: var(--error); }
    .log-entry.warning { color: var(--warning); }
    .log-entry.info { color: var(--info); }
    
    /* Provider Toggle */
    .provider-toggle {
      display: flex;
      gap: 8px;
    }
    
    .provider-btn {
      flex: 1;
      padding: 10px 16px;
      background: var(--bg-tertiary);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .provider-btn:hover {
      border-color: var(--accent-primary);
    }
    
    .provider-btn.active {
      background: var(--accent-gradient);
      border-color: transparent;
      color: white;
    }
    
    /* AI Action Buttons */
    .ai-action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
      padding: 12px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }
    
    .action-btn {
      padding: 8px 16px;
      background: var(--bg-card);
      border: 1px solid var(--accent-primary);
      border-radius: 6px;
      color: var(--accent-primary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .action-btn:hover {
      background: var(--accent-primary);
      color: white;
    }
    
    .action-btn.write {
      border-color: var(--warning);
      color: var(--warning);
    }
    
    .action-btn.write:hover {
      background: var(--warning);
      color: white;
    }
    
    .action-btn.decline {
      border-color: var(--text-muted);
      color: var(--text-muted);
    }
    
    .action-btn.decline:hover {
      background: var(--text-muted);
      color: white;
    }

    /* Function List */
    .function-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .function-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
      transition: all 0.2s;
    }

    .function-item:hover {
      background: var(--bg-tertiary);
    }

    .function-item:last-child {
      border-bottom: none;
    }

    .function-badge {
      font-size: 10px;
      padding: 3px 8px;
      border-radius: 4px;
      font-weight: 600;
    }

    .function-badge.read {
      background: rgba(34, 197, 94, 0.15);
      color: var(--success);
    }

    .function-badge.write {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }

    .function-name {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      flex: 1;
    }

    /* Tabs */
    .tabs {
      display: flex;
      border-bottom: 1px solid var(--border-color);
    }

    .tab {
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text-primary);
    }

    .tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Bytecode viewer */
    .bytecode-viewer {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px;
      background: var(--bg-primary);
      padding: 16px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      word-break: break-all;
      color: var(--text-muted);
    }

    .selector-highlight {
      background: rgba(99, 102, 241, 0.3);
      padding: 1px 2px;
      border-radius: 2px;
    }

    /* Log panel */
    .log-panel {
      max-height: 150px;
      overflow-y: auto;
    }

    .log-entry {
      display: flex;
      gap: 12px;
      padding: 8px 12px;
      border-bottom: 1px solid var(--border-color);
      font-size: 12px;
    }

    .log-time {
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-muted);
      font-size: 11px;
    }

    .log-msg { color: var(--text-secondary); }
    .log-entry.success .log-msg { color: var(--success); }
    .log-entry.error .log-msg { color: var(--error); }
    .log-entry.info .log-msg { color: var(--info); }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      width: 500px;
      max-width: 90vw;
    }

    .modal-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 16px;
      font-weight: 600;
    }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
    }

    .modal-body {
      padding: 24px;
    }

    /* Loader */
    .loader {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1400px) {
      .main {
        grid-template-columns: 300px 1fr 350px;
      }
    }

    @media (max-width: 1100px) {
      .main {
        grid-template-columns: 1fr;
      }
      
      .sidebar, .ai-panel {
        display: none;
      }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); position: relative; overflow: hidden;">
        <!-- Eris (main planet) -->
        <div style="width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, #8b5cf6, #4c1d95); border-radius: 50%; position: absolute; top: 50%; left: 45%; transform: translate(-50%, -50%);"></div>
        <!-- Dysnomia (moon) -->
        <div style="width: 8px; height: 8px; background: radial-gradient(circle at 30% 30%, #c4b5fd, #7c3aed); border-radius: 50%; position: absolute; top: 25%; right: 20%;"></div>
        <!-- Orbit ring -->
        <div style="width: 32px; height: 32px; border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 50%; position: absolute; top: 50%; left: 45%; transform: translate(-50%, -50%) rotate(-20deg);"></div>
      </div>
      <div>
        <div class="logo-text">Entropy AI</div>
        <div class="logo-subtitle">PulseChain Interface</div>
      </div>
    </div>
    <div class="header-status">
      <div class="status-badge" id="chainStatus">
        <span class="status-dot"></span>
        <span>Connecting...</span>
      </div>
      <div class="status-badge" id="walletStatus">
        <span class="status-dot"></span>
        <span>No Wallet</span>
      </div>
      <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()">
        Connect Wallet
      </button>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Left Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Load Contract</div>
        <div class="input-group">
          <div class="input-with-btn">
            <input type="text" class="input" id="contractAddress" placeholder="0x... or contract name">
            <button class="btn btn-primary" onclick="loadContract()">Load</button>
          </div>
        </div>
      </div>
      
      <div class="sidebar-section">
        <div class="sidebar-title">ğŸ”® My Dysnomia Identity</div>
        
        <div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">Enter your LAU address to find YUE & QINGs:</div>
        <div class="input-group" style="margin-bottom: 8px;">
          <input type="text" class="input" id="myLauAddress" placeholder="Your LAU contract address (0x...)">
        </div>
        <button class="btn btn-primary btn-sm" onclick="lookupFromLau()" style="width: 100%; margin-bottom: 12px;">ğŸ” Load My Identity</button>
        
        <div style="border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 4px;">
          <div style="font-size: 10px; color: var(--text-muted); margin-bottom: 6px;">Or search by wallet (requires CHO registration):</div>
          <div class="input-group" style="margin-bottom: 6px;">
            <input type="text" class="input" id="walletLookup" placeholder="Wallet address (0x...)" style="font-size: 11px; padding: 8px;">
          </div>
          <button class="btn btn-secondary btn-sm" onclick="findUserContracts()" style="width: 100%; font-size: 11px;">Search CHO Registry</button>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title">Dysnomia Ecosystem</div>
        <div class="contract-list" id="ecosystemContracts" style="max-height: 400px; overflow-y: auto;">
          <!-- Populated by JS -->
        </div>
      </div>

      <div class="sidebar-section">
        <div class="sidebar-title" style="display: flex; justify-content: space-between; align-items: center;">
          Recent
          <button class="btn btn-secondary btn-sm" onclick="clearRecentContracts()" style="padding: 2px 8px; font-size: 10px;">Clear</button>
        </div>
        <div class="contract-list" id="recentContracts">
          <div class="contract-item" style="justify-content: center; color: var(--text-muted);">
            No recent contracts
          </div>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <section class="content">
      <!-- Contract Info Card -->
      <div class="card" id="contractCard" style="display: none;">
        <div class="card-header">
          <div class="card-title">
            <span>ğŸ“‹</span>
            <span id="contractName">Contract</span>
            <span class="contract-item-type" id="contractType">ERC20</span>
          </div>
          <div style="display: flex; gap: 8px;">
            <button class="btn btn-secondary btn-sm" onclick="copyAddress()">ğŸ“‹ Copy</button>
            <button class="btn btn-secondary btn-sm" onclick="viewOnScan()">ğŸ”— PulseScan</button>
          </div>
        </div>
        <div class="card-body">
          <div class="contract-info">
            <div class="info-item">
              <div class="info-label">Address</div>
              <div class="info-value" id="contractAddr">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Verification</div>
              <div class="info-value" id="contractVerified">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Total Supply</div>
              <div class="info-value large" id="contractSupply">-</div>
            </div>
            <div class="info-item">
              <div class="info-label">Decimals</div>
              <div class="info-value large" id="contractDecimals">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Functions Card -->
      <div class="card" id="functionsCard" style="display: none;">
        <div class="card-header">
          <div class="card-title">
            <span>âš¡</span>
            Functions
          </div>
          <div class="tabs">
            <div class="tab active" onclick="showFunctionTab('all')">All</div>
            <div class="tab" onclick="showFunctionTab('read')">Read</div>
            <div class="tab" onclick="showFunctionTab('write')">Write</div>
          </div>
        </div>
        <div class="card-body" style="padding: 0;">
          <div class="function-list" id="functionList">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- Function Builder Card -->
      <div class="card" id="builderCard" style="display: none;">
        <div class="card-header">
          <div class="card-title">
            <span>ğŸ”§</span>
            Function Call
          </div>
        </div>
        <div class="card-body">
          <div class="function-builder">
            <div id="selectedFunction" style="margin-bottom: 16px;">
              <span style="color: var(--text-muted);">Select a function from the list above</span>
            </div>
            <div class="param-inputs" id="paramInputs">
              <!-- Populated dynamically -->
            </div>
            <div class="function-actions">
              <button class="btn btn-success" id="readBtn" onclick="executeFunction(true)">
                ğŸ“– Read
              </button>
              <button class="btn btn-warning" id="writeBtn" onclick="executeFunction(false)">
                âœï¸ Write
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Output Card -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">
            <span>ğŸ“¤</span>
            Output
          </div>
          <button class="btn btn-secondary btn-sm" onclick="copyOutput()">Copy</button>
        </div>
        <div class="card-body" style="padding: 0;">
          <div class="output-panel" id="outputPanel">
            <div class="output-content" id="outputContent">
Enter a contract address to begin.

Quick tips:
â€¢ Load verified contracts for full ABI
â€¢ Unverified contracts use bytecode analysis
â€¢ Use the AI assistant for help with unknown functions
            </div>
          </div>
        </div>
      </div>

      <!-- Bytecode Card -->
      <div class="card" id="bytecodeCard" style="display: none;">
        <div class="card-header">
          <div class="card-title">
            <span>ğŸ”</span>
            Bytecode Analysis
          </div>
          <button class="btn btn-secondary btn-sm" onclick="askClaudeAboutBytecode()">
            ğŸ§  Ask Claude
          </button>
        </div>
        <div class="card-body">
          <div id="selectorList" style="margin-bottom: 16px;">
            <!-- Selector analysis -->
          </div>
          <div class="bytecode-viewer" id="bytecodeViewer">
            <!-- Bytecode hex -->
          </div>
        </div>
      </div>
    </section>

    <!-- AI Panel -->
    <aside class="ai-panel">
      <div class="ai-header">
        <div class="ai-title">
          ğŸ§  <span>Dysnomia AI Guide</span>
        </div>
        <div style="display: flex; gap: 6px;">
          <button class="btn btn-secondary btn-sm" onclick="clearAIChat()" title="Clear chat">ğŸ—‘ï¸</button>
          <button class="btn btn-secondary btn-sm" onclick="openApiKeyModal()" title="API Settings">âš™ï¸</button>
        </div>
      </div>
      
      <div class="ai-config" id="aiConfig">
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px;">
          <span style="color: var(--text-muted); font-size: 11px;">API Key: Not configured</span>
          <button class="btn btn-secondary btn-sm" onclick="openApiKeyModal()" style="padding: 4px 10px; font-size: 10px;">Set Key</button>
        </div>
      </div>

      <div class="ai-messages" id="aiMessages">
        <div class="ai-message assistant">
          ğŸ”® Hi! I'm your Dysnomia AI Guide.

<b>To get started:</b>
1. Enter your LAU address in the sidebar
2. Click "Load My Identity" to find your YUE & QINGs
3. Ask me "what should I do next?"

I know the full Dysnomia architecture:
â€¢ Reactor math (SHA, SHIO, modExp64)
â€¢ Core chain & domain contracts  
â€¢ Terraforming layers
â€¢ How to execute transactions

<b>Set your API key to enable me!</b>
        </div>
      </div>

      <div class="ai-input-container" style="flex-shrink: 0;">
        <div class="ai-input-wrapper">
          <textarea class="ai-input" id="aiInput" placeholder="Ask about Dysnomia, get transaction help, learn the math..." rows="6"></textarea>
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="ai-quick-actions" style="margin: 0;">
              <button class="ai-quick-btn primary" onclick="quickAction('guide')">ğŸ§­ Next?</button>
              <button class="ai-quick-btn" onclick="quickAction('explain')">ğŸ“– Explain</button>
              <button class="ai-quick-btn" onclick="quickAction('react')">âš¡ React</button>
              <button class="ai-quick-btn" onclick="quickAction('math')">ğŸ”¢ Math</button>
            </div>
            <button class="btn btn-primary" onclick="sendToAI()" style="padding: 12px 24px; font-size: 14px;">Send</button>
          </div>
        </div>
      </div>
      
      <div class="ai-activity-log" style="flex-shrink: 0;">
        <div class="ai-activity-header" onclick="toggleActivityLog()">
          <span>ğŸ“‹ Activity Log</span>
          <span id="activityLogArrow">â–¶</span>
        </div>
        <div class="ai-activity-content collapsed" id="activityLog">
          <div class="log-entry">Ready.</div>
        </div>
      </div>
    </aside>
  </main>

  <!-- API Key Modal -->
  <div class="modal-overlay" id="apiKeyModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">ğŸ”‘ AI Configuration</div>
        <button class="modal-close" onclick="closeApiKeyModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="input-group" style="margin-bottom: 16px;">
          <label class="input-label">AI Provider</label>
          <div class="provider-toggle">
            <button class="provider-btn active" id="providerClaude" onclick="selectProvider('claude')">
              Claude (Anthropic)
            </button>
            <button class="provider-btn" id="providerGemini" onclick="selectProvider('gemini')">
              Gemini (Google)
            </button>
          </div>
        </div>
        
        <div id="claudeConfig">
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
            Get a Claude API key at <a href="https://console.anthropic.com" target="_blank" style="color: var(--accent-primary);">console.anthropic.com</a>
          </p>
          <div class="input-group">
            <label class="input-label">Anthropic API Key</label>
            <input type="password" class="input" id="apiKeyInput" placeholder="sk-ant-...">
          </div>
        </div>
        
        <div id="geminiConfig" style="display: none;">
          <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 12px;">
            Get a Gemini API key at <a href="https://aistudio.google.com/apikey" target="_blank" style="color: var(--accent-primary);">aistudio.google.com</a>
          </p>
          <div class="input-group">
            <label class="input-label">Google AI API Key</label>
            <input type="password" class="input" id="geminiKeyInput" placeholder="AIza...">
          </div>
        </div>
        
        <p style="color: var(--text-muted); font-size: 11px; margin: 12px 0;">
          ğŸ”’ Keys are stored in your browser only and sent directly to the provider.
        </p>
        <div style="display: flex; gap: 12px; margin-top: 20px;">
          <button class="btn btn-secondary" onclick="clearAllApiKeys()" style="flex: 0.5;">Clear All</button>
          <button class="btn btn-secondary" onclick="closeApiKeyModal()" style="flex: 0.5;">Cancel</button>
          <button class="btn btn-primary" onclick="saveApiKey()" style="flex: 1;">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ENTROPY AI - Full Application
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // State
    let provider = null;
    let signer = null;
    let currentContract = null;
    let currentAddress = null;
    let currentABI = null;
    let currentBytecode = null;
    let selectedFunction = null;
    let apiKey = localStorage.getItem('entropyAI_apiKey') || null;
    let geminiKey = localStorage.getItem('entropyAI_geminiKey') || null;
    let aiProvider = localStorage.getItem('entropyAI_provider') || 'claude';
    let recentContracts = JSON.parse(localStorage.getItem('entropyAI_recent') || '[]');

    // Constants
    const PULSESCAN_API = 'https://api.scan.pulsechain.com/api';
    const ANTHROPIC_API = '/api/chat';  // Use Vercel serverless function
    
    // CORS proxy no longer needed - using serverless function
    const USE_CORS_PROXY = false;
    const CORS_PROXY = '';

    // Known selectors with full ABI info
    const KNOWN_SELECTORS = {
      // ERC20 - READ
      '06fdde03': { sig: 'name()', view: true, returns: 'string' },
      '95d89b41': { sig: 'symbol()', view: true, returns: 'string' },
      '313ce567': { sig: 'decimals()', view: true, returns: 'uint8' },
      '18160ddd': { sig: 'totalSupply()', view: true, returns: 'uint256' },
      '70a08231': { sig: 'balanceOf(address)', view: true, returns: 'uint256' },
      'dd62ed3e': { sig: 'allowance(address,address)', view: true, returns: 'uint256' },
      'd5abeb01': { sig: 'maxSupply()', view: true, returns: 'uint256' },
      // ERC20 - WRITE
      'a9059cbb': { sig: 'transfer(address,uint256)', view: false, returns: 'bool' },
      '095ea7b3': { sig: 'approve(address,uint256)', view: false, returns: 'bool' },
      '23b872dd': { sig: 'transferFrom(address,address,uint256)', view: false, returns: 'bool' },
      'a457c2d7': { sig: 'decreaseAllowance(address,uint256)', view: false, returns: 'bool' },
      '39509351': { sig: 'increaseAllowance(address,uint256)', view: false, returns: 'bool' },
      // Mint/Burn
      'c4a11628': { sig: 'mint(address,uint256)', view: false, returns: 'bool' },
      '40c10f19': { sig: 'mint(address,uint256)', view: false, returns: 'bool' },
      'a0712d68': { sig: 'mint(uint256)', view: false },
      '42966c68': { sig: 'burn(uint256)', view: false },
      '79cc6790': { sig: 'burnFrom(address,uint256)', view: false },
      '9dc29fac': { sig: 'burn(address,uint256)', view: false },
      // Ownable - READ
      '8da5cb5b': { sig: 'owner()', view: true, returns: 'address' },
      '2f54bf6e': { sig: 'isOwner(address)', view: true, returns: 'bool' },
      'a0e67e2b': { sig: 'getOwners()', view: true, returns: 'address[]' },
      // Ownable - WRITE
      '7065cb48': { sig: 'addOwner(address)', view: false },
      '173825d9': { sig: 'removeOwner(address)', view: false },
      'f2fde38b': { sig: 'transferOwnership(address)', view: false },
      '715018a6': { sig: 'renounceOwnership()', view: false },
      // Pausable
      '5c975abb': { sig: 'paused()', view: true, returns: 'bool' },
      '8456cb59': { sig: 'pause()', view: false },
      '3f4ba83a': { sig: 'unpause()', view: false },
      // Dysnomia - READ
      'c2bc2efc': { sig: 'Xiao()', view: true, returns: 'address' },
      '4ac9b8c1': { sig: 'Type()', view: true, returns: 'string' },
      '8d09c163': { sig: 'Eta()', view: true, returns: 'address' },
      '1f7af498': { sig: 'Saat(uint256)', view: true, returns: 'uint64' },
      '6bb18556': { sig: 'CurrentArea()', view: true, returns: 'address' },
      '238ac933': { sig: 'Upsilon()', view: true, returns: 'address' },
      '5a6417c5': { sig: 'Xi()', view: true, returns: 'uint64' },
      '9fbd4b73': { sig: 'Monopole()', view: true, returns: 'uint64' },
      '0e8bfec1': { sig: 'Rod()', view: true, returns: 'address' },
      '3a1e7177': { sig: 'Cone()', view: true, returns: 'address' },
      '0f4ef8a6': { sig: 'Manifold()', view: true, returns: 'uint64' },
      'e8e68289': { sig: 'Entropy()', view: true, returns: 'uint64' },
      '6e8bd034': { sig: 'Waat()', view: true, returns: 'uint256' },
      '9d76ea58': { sig: 'Username()', view: true, returns: 'string' },
      '5d7cf830': { sig: 'Void()', view: true, returns: 'address' },
      '4f64b2be': { sig: 'Nu()', view: true, returns: 'address' },
      'fc0c546a': { sig: 'token()', view: true, returns: 'address' },
      '17d70f7c': { sig: 'tokenId()', view: true, returns: 'uint256' },
      // Dysnomia - WRITE
      '8d3a5862': { sig: 'Chat(string)', view: false },
      '7a0ed627': { sig: 'Enter(string,string)', view: false },
      '9c6c83fb': { sig: 'React(address,uint256)', view: false },
      '0e44c2c5': { sig: 'React(uint256)', view: false },
      'e83d4f64': { sig: 'React()', view: false },
      '6bc32fe2': { sig: 'React(address)', view: false },
      'd3dafe90': { sig: 'React(uint64)', view: false },
      '51cff8d9': { sig: 'Withdraw(address)', view: false },
      'f7888aec': { sig: 'Withdraw(address,uint256)', view: false },
      'b8b3c1e6': { sig: 'Log(string)', view: false },
      '6b8ab97d': { sig: 'Beat()', view: false },
      'b0604a26': { sig: 'Beat(uint256)', view: false },
      '7c5e63e7': { sig: 'On()', view: true, returns: 'tuple' },
      // Common DeFi
      '3ccfd60b': { sig: 'withdraw()', view: false },
      '2e1a7d4d': { sig: 'withdraw(uint256)', view: false },
      '853828b6': { sig: 'withdrawAll()', view: false },
      'd0e30db0': { sig: 'deposit()', view: false },
      'b6b55f25': { sig: 'deposit(uint256)', view: false },
      'a694fc3a': { sig: 'stake(uint256)', view: false },
      '2e17de78': { sig: 'unstake(uint256)', view: false },
      '372500ab': { sig: 'claimRewards()', view: false },
      '3d18b912': { sig: 'getReward()', view: false },
      'e9fad8ee': { sig: 'exit()', view: false },
      // Atropa specific
      'a035b1fe': { sig: 'price()', view: true, returns: 'uint256' },
      '4b750334': { sig: 'sellPrice()', view: true, returns: 'uint256' },
      '8620410b': { sig: 'buyPrice()', view: true, returns: 'uint256' },
    };

    // Known contracts
    const KNOWN_CONTRACTS = {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // DYSNOMIA ECOSYSTEM - FULL REGISTRY
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // MATH FOUNDATION
      'libAtropaMath': '0xB680F0cc810317933F234f67EB6A9E923407f05D',
      
      // CORE CHAIN
      'VOID': '0x965B0d74591bF30327075A247C47dBf487dCff08',
      'SIU': '0x43136735603D4060f226C279613A4dD97146937c',
      'YANG': '0xB702b3ec6d9De1011BE963EFe30A28b6dDFbe011',
      'YAU': '0x7e91d862A346659DaEEd93726e733C8C1347a225',
      'ZHOU': '0x5cC318d0c01FeD5942B5ED2F53dB07727d36E261',
      'ZHENG': '0x24E62C39e34d7fE2B7dF1162e1344eB6eb3b3e15',
      'YI': '0x4757438723055f14A1Af5C9651C2E37730F41A9E',
      
      // REACTORS
      'SHIO': '0xF6C50fFE7efbDeE63A92E52A4D5E9afF7fb4A4D7',
      'SHIO Rod': '0xE933F32BC3250C18A69f77775652E5C473c77f23',
      'SHIO Cone': '0x6DB334e06ce501DF6F5F2c4f94BF74cfccc65C89',
      'SHAFactory': '0x4208333D65A90577E3da39B84D6A95eb9db717D2',
      'SHIOFactory': '0x5063D2A97960DDE8dc5E3e5A69aAa379C6301F1C',
      
      // TANG DOMAIN
      'CHEON': '0x3d23084cA3F40465553797b5138CFC456E61FB5D',
      
      // SOENG DOMAIN
      'META': '0xE77Bdae31b2219e032178d88504Cc0170a5b9B97',
      'RING': '0x1574c84Ec7fA78fC6C749e1d242dbde163675e72',
      'PANG': '0xEe25Ccd41671F3B67d660cf6532085586aec8457',
      'ZI': '0xCbAdd3C3957Bd9D6C036863CB053FEccf3D53338',
      'CHOA': '0x0f5a352fd4cA4850c2099C15B3600ff085B66197',
      'SEI': '0x3dC54d46e030C42979f33C9992348a990acb6067',
      'CHAN': '0xe250bf9729076B14A8399794B61C72d0F4AeFcd8',
      'XIE': '0x4Df51741F2926525A21bF63E4769bA70633D2792',
      'XIA': '0x7f4a4DD4a6f233d2D82BE38b2F9fc0Fef46f25FA',
      'MAI': '0xc48B0a4E79eF302c8Eb5be71F562d08fB8E6A3d8',
      'QI': '0x4d9Ce396BE95dbc5F71808c38107eB7422FD9a03',
      
      // SPATIAL
      'MAP': '0xD3a7A95012Edd46Ea115c693B74c5e524b3DdA75',
      'HECKE': '0x29A924D9B0233026B9844f2aFeB202F1791D7593',
      
      // USER LAYER
      'CHO': '0xB6be11F0A788014C1F68C92F8D6CcC1AbF78F2aB',
      
      // LIBRARIES
      'ReactionsLib': '0x8704d7740735F6DEA0103366fE297Ba3F9fCaCc4',
      'LibAttribute': '0x529e3e15Da19c7c828f9CCE13C53F7031a30ec7c',
      
      // EXAMPLE QINGs
      'QING ZÃ¼rich': '0xb0Ba7D36B7F0505879179ecE7401F24eB653c6E1',
      'QING Illinois': '0xD127839B83cBf537c29B7d268c135f745a0Da2E8',
      
      // QING ASSETS
      'ZÃ¼rich': '0x583d1C1427308f7f96BFd3E0d7A3F9674D8BF8ec',
      'Illinois': '0x81A6923ca480FAda78CB15254c8D8Cc382D2fBC0',
      
      // EXAMPLE LAUs
      'LAU IronChad': '0xD2a00a61743f39Fe74096653E564107cc80457BA',
      'LAU mariarahel': '0xD32c39fEE49391c7952d1b30b15921b0D3b42E69',
      'LAU cLAUde': '0x3a668BB3DcE4A2573Be90A24Fd57771f9b1b9d30',
      'LAU EnterTeh': '0xccE83CfF8B531EaDdcf11AB414C59DC046D1aAc7',
      
      // EXAMPLE YUEs
      'YUE enteh': '0x59b1053F656Ed839d3CD9587b6364cd7E86207Dd',
      
      // ATROPA TOKENS
      'AFFECTION': '0x24F0154C1dCe548AdF15da2098Fdd8B8A3B8151D',
      'RESTRAININGORDER': '0xEf2125f5d1F7A3d68038F27e681258d13a73E718',
      'WITHOUT': '0x173216Ed67eBF3E6767D86e8b3Ff32e0d64437bF',
      'CROWS': '0x203e366A1821570b2f84Ff5ae8B3BdeB48Dc4fa1',
      'atropa': '0x7a20189B297343CF26d8548764b04891f37F3414',
      'Neptune': '0x9A3796Cf41B7CbA6921fd50c3f5204ED6506C3e7',
      'LOL': '0xA63F8061A67ecdbf147Cd1B60f91Cf95464E868D',
      'Buckingham': '0xe5d3A6e88590fc2A8037D9CCbd816C05B1ff5f11',
      
      // PULSECHAIN CORE
      'WPLS': '0xA1077a294dDE1B09bB078844df40758a5D0f9a27',
      'PLSX': '0x95B303987A60C71504D99Aa1b13B4DA07b0790ab',
      'INC': '0x2fa878Ab3F87CC1C9737Fc071108F904c0B0C95d',
      'HEX': '0x2b591e99afE9f32eAA6214f7B7629768c40Eeb39',
      'pDAI': '0xefD766cCb38EaF1dfd701853BFCe31359239F305',
      'pUSDC': '0x15D38573d2feeb82e7ad5187aB8c1D52810B1f07',
    };
    
    // Contract categories for sidebar
    const CONTRACT_CATEGORIES = {
      'Core Chain': ['VOID', 'SIU', 'YANG', 'YAU', 'ZHOU', 'ZHENG', 'YI'],
      'Reactors': ['SHIO', 'SHIO Rod', 'SHIO Cone', 'SHAFactory', 'SHIOFactory'],
      'TANG': ['CHEON'],
      'SOENG': ['META', 'RING', 'PANG', 'ZI', 'CHOA', 'SEI', 'CHAN', 'XIE', 'XIA', 'MAI', 'QI'],
      'Spatial': ['MAP', 'HECKE', 'CHO'],
      'QINGs': ['QING ZÃ¼rich', 'QING Illinois'],
      'LAUs': ['LAU IronChad', 'LAU mariarahel', 'LAU cLAUde', 'LAU EnterTeh'],
      'YUEs': ['YUE enteh'],
      'Libraries': ['libAtropaMath', 'ReactionsLib', 'LibAttribute'],
      'Atropa': ['atropa', 'AFFECTION', 'CROWS', 'Neptune', 'LOL', 'Buckingham'],
      'PulseChain': ['WPLS', 'PLSX', 'INC', 'HEX', 'pDAI', 'pUSDC'],
    };
    
    // Dysnomia contract type hierarchy for discovery
    const DYSNOMIA_HIERARCHY = {
      'VOID': { getter: 'Nu', returns: 'SIU' },
      'SIU': { getter: 'Psi', returns: 'YANG' },
      'YANG': { getter: 'Mu', returns: 'YAU' },
      'YAU': { getter: 'Tau', returns: 'ZHOU' },
      'ZHOU': { getter: 'Upsilon', returns: 'ZHENG' },
      'ZHENG': { getter: 'Eta', returns: 'YI' },
      'YI': { getter: 'Psi', returns: 'SHIO' },
      'SHIO': { getter: 'Rod', returns: 'SHA' },
      'META': { getter: 'Ring', returns: 'RING' },
      'RING': { getter: 'Pang', returns: 'PANG' },
      'PANG': { getter: 'Zi', returns: 'ZI' },
      'ZI': { getter: 'Choa', returns: 'CHOA' },
      'CHOA': { getter: 'Sei', returns: 'SEI' },
      'SEI': { getter: 'Chan', returns: 'CHAN' },
      'CHAN': { getter: 'Xie', returns: 'XIE' },
      'XIE': { getter: 'Xia', returns: 'XIA' },
      'XIA': { getter: 'Mai', returns: 'MAI' },
      'MAI': { getter: 'Qi', returns: 'QI' },
      'QI': { getter: 'Zuo', returns: 'MAP' },
      'YUE': { getter: 'Chan', returns: 'CHAN' },
      'LAU': { getter: 'Eta', returns: 'VOID' },
      'QING': { getter: 'Map', returns: 'MAP' },
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DYSNOMIA TYPE-SPECIFIC ABIs
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Standard ERC20 ABI (for non-Dysnomia tokens like DAI, WBTC, etc.)
    const ERC20_ABI = [
      'function name() view returns (string)',
      'function symbol() view returns (string)',
      'function decimals() view returns (uint8)',
      'function totalSupply() view returns (uint256)',
      'function balanceOf(address) view returns (uint256)',
      'function transfer(address,uint256) returns (bool)',
      'function approve(address,uint256) returns (bool)',
      'function allowance(address,address) view returns (uint256)',
      'function transferFrom(address,address,uint256) returns (bool)',
    ];

    // Dysnomia base extensions (all Dysnomia contracts have these)
    const DYSNOMIA_BASE = [
      'function maxSupply() view returns (uint256)',
      'function Xiao() view returns (address)',
      'function Type() view returns (string)',
      'function MotzkinPrime() view returns (uint64)',
      'function GetMarketRate(address) view returns (uint256)',
      'function Purchase(address,uint256)',
      'function Redeem(address,uint256)',
      'function Rename(string,string)',
      'function mintToCap()',
      'function addOwner(address)',
      'function removeOwner(address)',
      'function isOwner(address) view returns (bool)',
    ];

    // Type-specific ABIs - only loaded for contracts of that type
    const TYPE_ABI = {
      SHA: [
        'function Dynamo() view returns (uint64)',
        'function Fuse(uint64,uint64,uint64)',
        'function Avail(uint64)',
        'function Form(uint64)',
        'function Polarize()',
        'function Conjugate(uint64)',
        'function Conify(uint64)',
        'function Saturate(uint64,uint64,uint64)',
        'function Bond()',
        'function Adduct(uint64) returns (uint64)',
        'function React(uint64,uint64) returns (uint64,uint64)',
      ],
      SHIO: [
        'function Rod() view returns (address)',
        'function Cone() view returns (address)',
        'function Manifold() view returns (uint64)',
        'function Monopole() view returns (uint64)',
        'function Log(uint64,uint64,string)',
        'function Generate(uint64,uint64,uint64)',
        'function Isomerize()',
        'function Isolate()',
        'function Magnetize() returns (uint64)',
        'function React(uint64) returns (uint64,uint64)',
      ],
      YI: [
        'function Psi() view returns (address)',
        'function Xi() view returns (uint64)',
        'function Ring() view returns (uint64)',
        'function Beta(string,string) returns (address)',
        'function Kappa(address,address) returns (address)',
      ],
      ZHENG: [
        'function Eta() view returns (address)',
        'function GetRodByIdx(uint64)',
        'function Iodize(address)',
      ],
      ZHOU: [
        'function Upsilon() view returns (address)',
        'function Xi() view returns (uint64)',
        'function Monopole() view returns (uint64)',
        'function Alpha(string,string) returns (address)',
        'function React(uint64)',
      ],
      YAU: [
        'function Tau() view returns (address)',
        'function Monopole(uint256) view returns (uint64)',
        'function React()',
      ],
      YANG: [
        'function Mu() view returns (address)',
        'function Pole(uint256) view returns (uint64)',
      ],
      SIU: [
        'function Psi() view returns (address)',
        'function Aura() view returns (uint64)',
      ],
      VOID: [
        'function Nu() view returns (address)',
        'function GetLibraryAddress(string) view returns (address)',
        'function AddLibrary(string,address)',
        'function Log(string)',
        'function Chat(string)',
        'function SetAttribute(string,string)',
        'function GetAttribute(string) view returns (string)',
      ],
      LAU: [
        'function Eta() view returns (address)',
        'function Saat(uint256) view returns (uint64)',
        'function CurrentArea() view returns (address)',
        'function Username() view returns (string)',
        'function Chat(string)',
        'function Withdraw(address,uint256)',
        'function Leave()',
      ],
      CHO: [
        'function Void() view returns (address)',
        'function Saat(uint256) view returns (uint64)',
        'function Entropy() view returns (uint64)',
        'function Gua() view returns (uint256)',
        'function Enter(address)',
        'function GetUser()',
        'function GetUserSoul() view returns (uint64)',
        'function React(uint64) returns (uint64,uint64)',
        'function ReactUser(uint64,uint64) returns (uint64)',
        'function Luo() returns (uint256)',
      ],
      QING: [
        'function Cho() view returns (address)',
        'function Asset() view returns (address)',
        'function Waat() view returns (uint256)',
        'function Entropy() view returns (uint64)',
        'function GWAT() view returns (bool)',
        'function BouncerDivisor() view returns (uint16)',
        'function CoverCharge() view returns (uint256)',
        'function Join(address)',
        'function Chat(address,string)',
        'function Withdraw(address,uint256)',
      ],
      SEI: [
        'function Chan() view returns (address)',
        'function Chi() view returns (address,address)',
        'function Start(address,string,string)',
      ],
      CHEON: [
        'function Sei() view returns (address)',
        'function Su(address) returns (uint256,uint256,uint256)',
      ],
      META: [
        'function Ring() view returns (address)',
        'function Beat(uint256) returns (uint256,uint256,uint256,uint256)',
      ],
      CHAN: [
        'function Xie() view returns (address)',
        'function Yan(address) view returns (address)',
        'function AddYue(address,address)',
        'function TransferYue(address,address)',
        'function OptIn(address,bool)',
      ],
      RING: [
        'function Pang() view returns (address)',
        'function Phobos() view returns (address)',
        'function Moments(uint64) view returns (uint256)',
        'function Eta() returns (uint256,uint256,uint256,uint256)',
      ],
      QI: [
        'function Zuo() view returns (address)',
        'function Eris() view returns (address)',
        'function ReactSoul(uint64) returns (uint256)',
        'function ReactWaat(uint256) view returns (uint256)',
      ],
      MAI: [
        'function Qi() view returns (address)',
        'function React(uint64,uint256) returns (uint256)',
      ],
      XIA: [
        'function Mai() view returns (address)',
        'function Fomalhaute() view returns (address)',
        'function Charge(uint256) returns (uint256)',
      ],
      XIE: [
        'function Xia() view returns (address)',
        'function Fornax() view returns (address)',
        'function Power(uint256) returns (uint256,uint256,uint256)',
      ],
      ZI: [
        'function Choa() view returns (address)',
        'function Tethys() view returns (address)',
        'function Spin(uint256) returns (uint256,uint256,uint256,uint256)',
      ],
      PANG: [
        'function Zi() view returns (address)',
        'function Push(uint256) returns (uint256,uint256,uint256,uint256,uint256)',
      ],
      CHOA: [
        'function Sei() view returns (address)',
        'function Yuan(address) view returns (uint256)',
        'function Play(address)',
        'function Chat(address,string) returns (uint256)',
      ],
      GWAT: [
        'function War() view returns (address)',
        'function GetMapGwat(int256,int256) view returns (address)',
        'function Gwat(address,uint256)',
      ],
      WAR: [
        'function World() view returns (address)',
        'function Water() view returns (address)',
        'function CO2() view returns (uint256)',
        'function Faa(address,uint256) returns (uint256)',
      ],
      AFFECTION: [
        'function React(address,uint256)',
        'function Issuance() view returns (uint256)',
      ],
    };

    // Helper: Check if contract is Dysnomia by checking for Type() first, then Xiao()
    async function checkDysnomia(address) {
      log('Checking if Dysnomia...', 'info');
      
      // Method 1: Check for Type() first - this is the most reliable indicator
      try {
        const c = new ethers.Contract(address, ['function Type() view returns (string)'], provider);
        const type = await c.Type();
        log(`Type() = "${type}"`, 'info');
        if (type) {
          log(`âœ“ Dysnomia detected via Type()`, 'success');
          return true;
        }
      } catch (e) {
        log('Type() failed', 'info');
      }
      
      // Method 2: Check for Xiao() - standard DYSNOMIA tokens
      try {
        const c = new ethers.Contract(address, ['function Xiao() view returns (address)'], provider);
        const xiao = await c.Xiao();
        if (xiao && xiao !== '0x0000000000000000000000000000000000000000') {
          log('âœ“ Dysnomia detected via Xiao()', 'success');
          return true;
        }
      } catch (e) {
        log('Xiao() failed', 'info');
      }
      
      log('Not a Dysnomia contract', 'info');
      return false;
    }

    // Helper: Get Dysnomia contract type
    async function getDysnomiaType(address) {
      try {
        const c = new ethers.Contract(address, ['function Type() view returns (string)'], provider);
        const type = await c.Type();
        log(`getDysnomiaType: ${type}`, 'info');
        return type;
      } catch (e) {
        log('getDysnomiaType failed', 'error');
        return null;
      }
    }

    // Helper: Build full ABI for a contract
    function buildDysnomiaABI(type) {
      let abi = [...ERC20_ABI, ...DYSNOMIA_BASE];
      if (TYPE_ABI[type]) {
        abi = [...abi, ...TYPE_ABI[type]];
        log(`Built ABI for ${type}: ${abi.length} functions`, 'success');
      } else {
        log(`No TYPE_ABI for "${type}" - using base only`, 'warning');
      }
      return abi;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ECOSYSTEM EXPLORER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Track collapsed state
    let collapsedCategories = new Set(['PulseChain', 'Atropa']); // Start with some collapsed
    
    function renderEcosystemContracts() {
      const container = document.getElementById('ecosystemContracts');
      let html = '';
      
      Object.entries(CONTRACT_CATEGORIES).forEach(([category, contracts]) => {
        const isCollapsed = collapsedCategories.has(category);
        const icon = getCategoryIcon(category);
        
        html += `
          <div class="ecosystem-category">
            <div class="category-header" onclick="toggleCategory('${category}')">
              <span>${icon} ${category}</span>
              <span class="category-arrow">${isCollapsed ? 'â–¶' : 'â–¼'}</span>
            </div>
            <div class="category-contracts" style="display: ${isCollapsed ? 'none' : 'block'}">
        `;
        
        contracts.forEach(name => {
          const addr = KNOWN_CONTRACTS[name];
          if (addr) {
            html += `
              <div class="contract-item" onclick="loadContract('${addr}')">
                <div>
                  <div class="contract-item-name">${name}</div>
                  <div class="contract-item-addr">${addr.slice(0, 8)}...${addr.slice(-6)}</div>
                </div>
              </div>
            `;
          }
        });
        
        html += `</div></div>`;
      });
      
      container.innerHTML = html;
    }
    
    function getCategoryIcon(category) {
      const icons = {
        'Core Chain': 'â›“ï¸',
        'Reactors': 'âš›ï¸',
        'TANG': 'â˜ï¸',
        'SOENG': 'ğŸ”®',
        'Spatial': 'ğŸ—ºï¸',
        'QINGs': 'ğŸ“',
        'LAUs': 'ğŸ‘¤',
        'YUEs': 'ğŸŒ',
        'Libraries': 'ğŸ“š',
        'Atropa': 'ğŸŒ¿',
        'PulseChain': 'ğŸ’œ',
      };
      return icons[category] || 'ğŸ“';
    }
    
    function toggleCategory(category) {
      if (collapsedCategories.has(category)) {
        collapsedCategories.delete(category);
      } else {
        collapsedCategories.add(category);
      }
      renderEcosystemContracts();
    }
    
    // Find user's LAU, YUE, and QINGs
    let userContracts = {
      wallet: null,
      lau: null,
      yue: null,
      qings: [],
      currentArea: null,
      registered: false
    };
    
    async function findUserContracts() {
      const wallet = document.getElementById('walletLookup').value.trim();
      
      if (!wallet || !ethers.isAddress(wallet)) {
        log('Please enter a valid wallet address', 'error');
        return;
      }
      
      userContracts.wallet = wallet;
      log(`ğŸ” Searching for contracts owned by ${wallet.slice(0,8)}...`, 'info');
      
      let results = [];
      
      // Method 1: Try CHO.GetUserTokenAddress (requires user to have called Enter())
      try {
        log('Checking CHO.GetUserTokenAddress...', 'info');
        const cho = new ethers.Contract(KNOWN_CONTRACTS['CHO'], [
          'function GetUserTokenAddress(address) view returns (address)',
          'function Delegates(address) view returns (uint64 Soul, tuple(address Phi, uint64 Mu, uint64 Xi, address Pi, address Shio, address Ring, uint64 Omicron, uint64 Omega) On, string Username, uint64 Entropy)',
        ], provider);
        
        const lauAddress = await cho.GetUserTokenAddress(wallet);
        
        if (lauAddress && lauAddress !== ethers.ZeroAddress) {
          log(`âœ… Found registered LAU: ${lauAddress}`, 'success');
          userContracts.lau = lauAddress;
          userContracts.registered = true;
          
          const lau = new ethers.Contract(lauAddress, [
            'function name() view returns (string)',
            'function symbol() view returns (string)',
            'function CurrentArea() view returns (address)',
          ], provider);
          
          let lauName = 'Your LAU';
          try { lauName = await lau.name(); } catch {}
          
          results.push(`âœ… LAU (registered): ${lauName} (${lauAddress.slice(0,10)}...)`);
          addDiscoveredContract(lauName, lauAddress, 'LAU');
          
          // Get current area (QING) from LAU
          try {
            const currentArea = await lau.CurrentArea();
            if (currentArea && currentArea !== ethers.ZeroAddress) {
              userContracts.currentArea = currentArea;
              log(`âœ… Found Current QING: ${currentArea}`, 'success');
              
              const qing = new ethers.Contract(currentArea, [
                'function name() view returns (string)',
              ], provider);
              let qingName = 'Your QING';
              try { qingName = await qing.name(); } catch {}
              
              results.push(`âœ… Current QING: ${qingName} (${currentArea.slice(0,10)}...)`);
              addDiscoveredContract(qingName, currentArea, 'QING');
              userContracts.qings.push(currentArea);
            }
          } catch (e) {
            log(`No CurrentArea on LAU: ${e.message}`, 'info');
          }
        } else {
          log('No LAU registered in CHO - checking if user has called Enter()', 'info');
          results.push(`âš ï¸ No LAU registered in CHO`);
          results.push(`   â†’ You may need to call CHO.Enter(yourLauAddress) to register`);
        }
      } catch (e) {
        log(`CHO lookup error: ${e.message}`, 'warning');
        results.push(`âš ï¸ CHO lookup error: ${e.message.slice(0,50)}...`);
      }
      
      // Method 2: Check known LAUs for ownership
      if (!userContracts.lau) {
        log('Checking known LAUs for ownership...', 'info');
        const knownLaus = Object.entries(KNOWN_CONTRACTS).filter(([k]) => k.startsWith('LAU'));
        
        for (const [name, addr] of knownLaus) {
          try {
            const lau = new ethers.Contract(addr, [
              'function owner(address) view returns (bool)',
              'function isOwner(address) view returns (bool)',
              'function balanceOf(address) view returns (uint256)',
            ], provider);
            
            let isOwner = false;
            try { isOwner = await lau.owner(wallet); } catch {}
            if (!isOwner) try { isOwner = await lau.isOwner(wallet); } catch {}
            
            if (isOwner) {
              log(`âœ… Found LAU ownership: ${name} at ${addr}`, 'success');
              userContracts.lau = addr;
              results.push(`âœ… LAU (owned, not registered): ${name}`);
              results.push(`   â†’ Call CHO.Enter("${addr}") to register`);
              addDiscoveredContract(name + ' (unregistered)', addr, 'LAU');
              break;
            }
          } catch {}
        }
      }
      
      // Method 3: Try CHAN.Yan for YUE
      try {
        log('Checking CHAN.Yan for YUE...', 'info');
        const chan = new ethers.Contract(KNOWN_CONTRACTS['CHAN'], [
          'function Yan(address) view returns (address)',
        ], provider);
        
        const yueAddress = await chan.Yan(wallet);
        
        if (yueAddress && yueAddress !== ethers.ZeroAddress) {
          log(`âœ… Found YUE: ${yueAddress}`, 'success');
          userContracts.yue = yueAddress;
          
          const yue = new ethers.Contract(yueAddress, [
            'function name() view returns (string)',
          ], provider);
          let yueName = 'Your YUE';
          try { yueName = await yue.name(); } catch {}
          
          results.push(`âœ… YUE: ${yueName} (${yueAddress.slice(0,10)}...)`);
          addDiscoveredContract(yueName, yueAddress, 'YUE');
        } else {
          results.push(`âŒ No YUE found`);
          results.push(`   â†’ Call SEI.Start(yourLauAddress, name, symbol) to create`);
        }
      } catch (e) {
        log(`CHAN.Yan error: ${e.message}`, 'warning');
        results.push(`âš ï¸ YUE lookup error`);
      }
      
      // Summary
      let summary = `ğŸ”® Dysnomia Contract Discovery\n\nWallet: ${wallet}\n\n${results.join('\n')}`;
      
      if (!userContracts.registered && userContracts.lau) {
        summary += `\n\nâš ï¸ Your LAU exists but isn't registered in CHO.`;
        summary += `\nTo register, call: CHO.Enter("${userContracts.lau}")`;
      } else if (!userContracts.lau) {
        summary += `\n\nğŸ’¡ No LAU found. To create one:`;
        summary += `\n1. Deploy a new LAU contract, or`;
        summary += `\n2. Check if you own one at a different address`;
      }
      
      summary += `\n\nğŸ’¡ Ask the AI "what should I do next?" for guidance!`;
      
      setOutput(summary);
      updateAIContext();
    }
    
    function updateAIContext() {
      window.userDysnomiaContext = {
        ...userContracts,
        loadedContract: currentAddress,
        loadedType: document.getElementById('contractType')?.textContent,
      };
    }
    
    // LAU-first lookup - the primary way to find your identity
    async function lookupFromLau() {
      const lauAddress = document.getElementById('myLauAddress').value.trim();
      
      if (!lauAddress || !ethers.isAddress(lauAddress)) {
        log('Please enter a valid LAU contract address', 'error');
        return;
      }
      
      log(`ğŸ” Loading identity from LAU: ${lauAddress.slice(0,10)}...`, 'info');
      
      let results = [];
      results.push(`ğŸ”® DYSNOMIA IDENTITY LOOKUP`);
      results.push(`${'â•'.repeat(40)}`);
      
      try {
        const lau = new ethers.Contract(lauAddress, [
          'function Type() view returns (string)',
          'function name() view returns (string)',
          'function symbol() view returns (string)',
          'function Username() view returns (string)',
          'function Saat(uint256) view returns (uint64)',
          'function CurrentArea() view returns (address)',
          'function Eta() view returns (address)',
          'function On() view returns (tuple(address Phi, uint64 Mu, uint64 Xi, address Pi, address Shio, address Ring, uint64 Omicron, uint64 Omega))',
        ], provider);
        
        // Verify it's a LAU
        let contractType = '';
        try { contractType = await lau.Type(); } catch {}
        
        if (contractType !== 'LAU') {
          log(`Warning: Type is "${contractType || 'unknown'}", expected "LAU"`, 'warning');
          results.push(`âš ï¸ Contract type: ${contractType || 'unknown'} (expected LAU)`);
        }
        
        // Get LAU details
        let name = '', symbol = '', username = '';
        let pole = '', soul = '', aura = '';
        
        try { name = await lau.name(); } catch {}
        try { symbol = await lau.symbol(); } catch {}
        try { username = await lau.Username(); } catch {}
        try { pole = (await lau.Saat(0)).toString(); } catch {}
        try { soul = (await lau.Saat(1)).toString(); } catch {}
        try { aura = (await lau.Saat(2)).toString(); } catch {}
        
        userContracts.lau = lauAddress;
        
        results.push(``);
        results.push(`ğŸ‘¤ LAU TOKEN`);
        results.push(`   Address: ${lauAddress}`);
        results.push(`   Name: ${name || 'Unknown'}`);
        results.push(`   Symbol: ${symbol || 'Unknown'}`);
        if (username) results.push(`   Username: ${username}`);
        results.push(`   Saat[0] Pole: ${pole}`);
        results.push(`   Saat[1] Soul: ${soul}`);
        results.push(`   Saat[2] Aura: ${aura}`);
        
        addDiscoveredContract(name || 'My LAU', lauAddress, 'LAU');
        log(`âœ… LAU loaded: ${name || lauAddress.slice(0,10)}`, 'success');
        
        // Get VOID reference
        try {
          const voidAddr = await lau.Eta();
          if (voidAddr && voidAddr !== ethers.ZeroAddress) {
            results.push(`   VOID: ${voidAddr.slice(0,10)}...`);
          }
        } catch {}
        
        // Get Current QING
        results.push(``);
        try {
          const currentArea = await lau.CurrentArea();
          if (currentArea && currentArea !== ethers.ZeroAddress) {
            userContracts.currentArea = currentArea;
            userContracts.qings.push(currentArea);
            
            const qing = new ethers.Contract(currentArea, [
              'function name() view returns (string)',
              'function symbol() view returns (string)',
              'function Waat() view returns (uint256)',
              'function Entropy() view returns (uint64)',
            ], provider);
            
            let qingName = '', qingSymbol = '', waat = '', entropy = '';
            try { qingName = await qing.name(); } catch {}
            try { qingSymbol = await qing.symbol(); } catch {}
            try { waat = (await qing.Waat()).toString(); } catch {}
            try { entropy = (await qing.Entropy()).toString(); } catch {}
            
            results.push(`ğŸ“ CURRENT QING (Territory)`);
            results.push(`   Address: ${currentArea}`);
            results.push(`   Name: ${qingName || 'Unknown'}`);
            if (waat) results.push(`   Waat: ${waat}`);
            if (entropy) results.push(`   Entropy: ${entropy}`);
            
            addDiscoveredContract(qingName || 'My QING', currentArea, 'QING');
            log(`âœ… QING found: ${qingName || currentArea.slice(0,10)}`, 'success');
          } else {
            results.push(`ğŸ“ CURRENT QING: None (not in any territory)`);
            results.push(`   â†’ Enter a QING to start terraforming`);
          }
        } catch (e) {
          results.push(`ğŸ“ CURRENT QING: Unable to read (${e.message.slice(0,30)})`);
        }
        
        // Try to find YUE via CHAN
        results.push(``);
        try {
          // First get the On struct to find the Shio
          const onData = await lau.On();
          if (onData && onData.Shio && onData.Shio !== ethers.ZeroAddress) {
            results.push(`âš›ï¸ SHIO (Reactor)`);
            results.push(`   Address: ${onData.Shio}`);
            addDiscoveredContract('My SHIO', onData.Shio, 'SHIO');
          }
        } catch {}
        
        // Check for YUE - need wallet address for this
        const walletInput = document.getElementById('walletLookup').value.trim();
        if (walletInput && ethers.isAddress(walletInput)) {
          try {
            const chan = new ethers.Contract(KNOWN_CONTRACTS['CHAN'], [
              'function Yan(address) view returns (address)',
            ], provider);
            
            const yueAddress = await chan.Yan(walletInput);
            
            if (yueAddress && yueAddress !== ethers.ZeroAddress) {
              userContracts.yue = yueAddress;
              userContracts.wallet = walletInput;
              
              const yue = new ethers.Contract(yueAddress, [
                'function name() view returns (string)',
                'function symbol() view returns (string)',
              ], provider);
              
              let yueName = '';
              try { yueName = await yue.name(); } catch {}
              
              results.push(`ğŸŒ YUE (IOT Bridge)`);
              results.push(`   Address: ${yueAddress}`);
              results.push(`   Name: ${yueName || 'Unknown'}`);
              
              addDiscoveredContract(yueName || 'My YUE', yueAddress, 'YUE');
              log(`âœ… YUE found: ${yueName || yueAddress.slice(0,10)}`, 'success');
            } else {
              results.push(`ğŸŒ YUE: Not found for wallet ${walletInput.slice(0,10)}...`);
              results.push(`   â†’ Call SEI.Start() to create one`);
            }
          } catch (e) {
            results.push(`ğŸŒ YUE: Lookup failed`);
          }
        } else {
          results.push(`ğŸŒ YUE: Enter wallet address to find YUE`);
        }
        
        // Summary
        results.push(``);
        results.push(`${'â•'.repeat(40)}`);
        results.push(`ğŸ’¡ Ask the AI "what should I do next?" for guidance!`);
        
        setOutput(results.join('\n'));
        updateAIContext();
        
      } catch (e) {
        log(`Error loading LAU: ${e.message}`, 'error');
        setOutput(`Error loading LAU:\n${e.message}\n\nMake sure this is a valid LAU contract address.`);
      }
    }
    
    function clearRecentContracts() {
      recentContracts = [];
      localStorage.removeItem('entropyAI_recent');
      updateRecentList();
      log('Recent contracts cleared', 'info');
    }
    
    function toggleActivityLog() {
      const content = document.getElementById('activityLog');
      const arrow = document.getElementById('activityLogArrow');
      if (content.classList.contains('collapsed')) {
        content.classList.remove('collapsed');
        arrow.textContent = 'â–¼';
      } else {
        content.classList.add('collapsed');
        arrow.textContent = 'â–¶';
      }
    }
    
    async function verifyLauOwnership() {
      const lauAddress = document.getElementById('manualLauAddress').value.trim();
      const wallet = document.getElementById('walletLookup').value.trim();
      
      if (!lauAddress || !ethers.isAddress(lauAddress)) {
        log('Please enter a valid LAU contract address', 'error');
        return;
      }
      
      if (!wallet || !ethers.isAddress(wallet)) {
        log('Please enter your wallet address first', 'error');
        return;
      }
      
      log(`ğŸ” Verifying LAU ownership...`, 'info');
      
      try {
        const lau = new ethers.Contract(lauAddress, [
          'function Type() view returns (string)',
          'function name() view returns (string)',
          'function symbol() view returns (string)',
          'function owner(address) view returns (bool)',
          'function isOwner(address) view returns (bool)',
          'function Saat(uint256) view returns (uint64)',
          'function Username() view returns (string)',
          'function CurrentArea() view returns (address)',
          'function Eta() view returns (address)',
        ], provider);
        
        // Check if it's a LAU
        let contractType = '';
        try { contractType = await lau.Type(); } catch {}
        
        if (contractType !== 'LAU') {
          log(`This doesn't appear to be a LAU contract (Type: ${contractType || 'unknown'})`, 'warning');
        }
        
        // Check ownership
        let isOwner = false;
        try { isOwner = await lau.owner(wallet); } catch (e) {
          log(`owner() failed: ${e.message}`, 'warning');
        }
        if (!isOwner) {
          try { isOwner = await lau.isOwner(wallet); } catch {}
        }
        
        // Get LAU details
        let name = '', symbol = '', username = '', soul = '';
        try { name = await lau.name(); } catch {}
        try { symbol = await lau.symbol(); } catch {}
        try { username = await lau.Username(); } catch {}
        try { soul = (await lau.Saat(1)).toString(); } catch {}
        
        let results = [];
        results.push(`LAU Contract: ${lauAddress}`);
        results.push(`Name: ${name || 'Unknown'}`);
        results.push(`Symbol: ${symbol || 'Unknown'}`);
        results.push(`Type: ${contractType || 'Unknown'}`);
        if (username) results.push(`Username: ${username}`);
        if (soul) results.push(`Soul (Saat[1]): ${soul}`);
        results.push('');
        results.push(`Wallet: ${wallet}`);
        results.push(`Ownership: ${isOwner ? 'âœ… YOU OWN THIS LAU!' : 'âŒ Not owned by this wallet'}`);
        
        if (isOwner) {
          userContracts.lau = lauAddress;
          userContracts.wallet = wallet;
          addDiscoveredContract(name || 'Your LAU', lauAddress, 'LAU');
          
          // Check if registered in CHO
          try {
            const cho = new ethers.Contract(KNOWN_CONTRACTS['CHO'], [
              'function GetUserTokenAddress(address) view returns (address)',
            ], provider);
            const registeredLau = await cho.GetUserTokenAddress(wallet);
            if (registeredLau === lauAddress) {
              results.push(`CHO Registration: âœ… Registered`);
              userContracts.registered = true;
            } else if (registeredLau === ethers.ZeroAddress) {
              results.push(`CHO Registration: âŒ Not registered`);
              results.push(`â†’ Call CHO.Enter("${lauAddress}") to register`);
            } else {
              results.push(`CHO Registration: âš ï¸ Different LAU registered (${registeredLau.slice(0,10)}...)`);
            }
          } catch {}
          
          // Get current area
          try {
            const currentArea = await lau.CurrentArea();
            if (currentArea && currentArea !== ethers.ZeroAddress) {
              userContracts.currentArea = currentArea;
              results.push(`Current QING: ${currentArea}`);
              addDiscoveredContract('Your QING', currentArea, 'QING');
            }
          } catch {}
          
          log(`âœ… LAU ownership verified!`, 'success');
        } else {
          log(`âŒ Wallet does not own this LAU`, 'warning');
        }
        
        setOutput(results.join('\n'));
        updateAIContext();
        
      } catch (e) {
        log(`Error verifying LAU: ${e.message}`, 'error');
        setOutput(`Error verifying LAU:\n${e.message}\n\nMake sure the address is a valid LAU contract.`);
      }
    }
    
    function addDiscoveredContract(name, address, type) {
      // Add to recent contracts for easy access
      const item = { name, address, type, discovered: true };
      
      // Remove if already exists
      recentContracts = recentContracts.filter(c => c.address !== address);
      
      // Add to front
      recentContracts.unshift(item);
      
      // Keep max 10
      if (recentContracts.length > 10) recentContracts.pop();
      
      // Save and update
      localStorage.setItem('entropyAI_recent', JSON.stringify(recentContracts));
      updateRecentList();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function init() {
      log('Initializing Entropy AI...', 'info');
      
      // Check if opened as file://
      if (window.location.protocol === 'file:') {
        document.getElementById('walletStatus').innerHTML = `
          <span class="status-dot"></span>
          <span style="color: var(--warning);">âš ï¸ file:// mode</span>
        `;
        document.getElementById('connectBtn').textContent = 'Run Server';
        document.getElementById('connectBtn').title = 'Wallet requires http:// - click for instructions';
        log('Running in file:// mode - wallet disabled', 'warning');
        setOutput(`âš ï¸ Running in file:// mode

Wallet extensions cannot connect to local files for security reasons.

To enable wallet connectivity:

Option 1 - Local Server (Recommended):
  1. Open Terminal
  2. Navigate to this file: cd ~/Downloads
  3. Run: python3 -m http.server 8080
  4. Open: http://localhost:8080/entropy_ai_app.html

Option 2 - Use Injectable Version:
  Open app.pulsex.com and paste entropy_ai_v5.js in console

Read functions still work! Only write functions need a wallet.`);
      }
      
      // Connect to PulseChain RPC
      try {
        provider = new ethers.JsonRpcProvider('https://rpc.pulsechain.com');
        const block = await provider.getBlockNumber();
        document.getElementById('chainStatus').innerHTML = `
          <span class="status-dot"></span>
          <span>Block ${block.toLocaleString()}</span>
        `;
        document.getElementById('chainStatus').classList.add('connected');
        log(`Connected to PulseChain (Block ${block})`, 'success');
      } catch (e) {
        document.getElementById('chainStatus').innerHTML = `
          <span class="status-dot"></span>
          <span>RPC Error</span>
        `;
        document.getElementById('chainStatus').classList.add('error');
        log('Failed to connect to PulseChain RPC', 'error');
      }

      // Check wallet
      if (window.ethereum) {
        try {
          const accounts = await window.ethereum.request({ method: 'eth_accounts' });
          if (accounts.length > 0) {
            updateWalletStatus(accounts[0]);
          }
        } catch (e) {}

        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length > 0) {
            updateWalletStatus(accounts[0]);
          } else {
            document.getElementById('walletStatus').innerHTML = `
              <span class="status-dot"></span>
              <span>Disconnected</span>
            `;
            document.getElementById('walletStatus').classList.remove('connected');
          }
        });
      }

      // Populate ecosystem contracts with categories
      renderEcosystemContracts();

      // Update recent
      updateRecentList();

      // Check API key status
      updateAIConfigStatus();

      log('Ready', 'success');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WALLET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function connectWallet() {
      // Check if opened as file://
      if (window.location.protocol === 'file:') {
        const msg = `âš ï¸ Wallet extensions don't work with file:// URLs.

To connect your wallet, run a local server:

1. Open Terminal
2. cd to the folder with this file
3. Run: python3 -m http.server 8080
4. Open: http://localhost:8080/entropy_ai_app.html

Or drag this file to a browser tab on a dApp site like app.pulsex.com`;
        
        alert(msg);
        log('Cannot connect wallet from file:// URL', 'error');
        setOutput(msg);
        return;
      }

      if (!window.ethereum) {
        alert('No wallet detected! Please install Rabby or MetaMask.');
        return;
      }

      try {
        log('Connecting wallet...', 'info');
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        
        // Switch to PulseChain
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: '0x171' }],
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: '0x171',
                chainName: 'PulseChain',
                nativeCurrency: { name: 'PLS', symbol: 'PLS', decimals: 18 },
                rpcUrls: ['https://rpc.pulsechain.com'],
                blockExplorerUrls: ['https://scan.pulsechain.com']
              }],
            });
          }
        }

        updateWalletStatus(accounts[0]);
        
        const browserProvider = new ethers.BrowserProvider(window.ethereum);
        signer = await browserProvider.getSigner();
        
        log('Wallet connected: ' + accounts[0].slice(0, 8) + '...', 'success');
      } catch (e) {
        log('Wallet connection failed: ' + e.message, 'error');
      }
    }

    function updateWalletStatus(address) {
      document.getElementById('walletStatus').innerHTML = `
        <span class="status-dot"></span>
        <span>${address.slice(0, 6)}...${address.slice(-4)}</span>
      `;
      document.getElementById('walletStatus').classList.add('connected');
      document.getElementById('connectBtn').textContent = 'Connected';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONTRACT LOADING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadContract(addressOrName) {
      const input = addressOrName || document.getElementById('contractAddress').value.trim();
      if (!input) return;

      // Resolve name to address
      let address = input;
      if (!input.startsWith('0x')) {
        address = KNOWN_CONTRACTS[input];
        if (!address) {
          log('Unknown contract name: ' + input, 'error');
          return;
        }
      }

      currentAddress = address;
      log('Loading ' + address.slice(0, 10) + '...', 'info');
      setOutput('Loading contract...');

      // Show cards
      document.getElementById('contractCard').style.display = 'block';
      document.getElementById('functionsCard').style.display = 'block';
      document.getElementById('builderCard').style.display = 'block';

      // Update address display
      document.getElementById('contractAddr').textContent = address;

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // SMART ABI DETECTION
      // Priority: 1) Dysnomia Type ABI  2) PulseScan Verified  3) Bytecode Analysis
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      let abi = null;
      let verified = false;
      let isDysnomia = false;
      let contractType = 'ERC20';

      // Step 1: Check if it's a Dysnomia contract (has Xiao function)
      isDysnomia = await checkDysnomia(address);
      
      if (isDysnomia) {
        // Get the specific type (ZHOU, LAU, VOID, etc.)
        contractType = await getDysnomiaType(address) || 'DYSNOMIA';
        
        // Build the complete ABI for this type
        abi = buildDysnomiaABI(contractType);
        
        log(`Dysnomia ${contractType} detected - using built-in ABI`, 'success');
        document.getElementById('contractVerified').innerHTML = `<span style="color: var(--accent-primary)">âš¡ Dysnomia ${contractType}</span>`;
        document.getElementById('bytecodeCard').style.display = 'none';
        verified = true; // We have full ABI
      } else {
        // Step 2: Try to fetch verified ABI from PulseScan
        abi = await fetchABI(address);
        
        if (abi) {
          verified = true;
          document.getElementById('contractVerified').innerHTML = '<span style="color: var(--success)">âœ“ Verified</span>';
          document.getElementById('bytecodeCard').style.display = 'none';
        } else {
          // Step 3: Unverified - analyze bytecode
          document.getElementById('contractVerified').innerHTML = '<span style="color: var(--warning)">âš  Unverified</span>';
          
          currentBytecode = await provider.getCode(address);
          if (currentBytecode === '0x') {
            log('Not a contract!', 'error');
            setOutput('This address is not a contract.');
            return;
          }

          const analysis = analyzesBytecode(currentBytecode);
          abi = analysis.abi;
          
          document.getElementById('bytecodeCard').style.display = 'block';
          document.getElementById('selectorList').innerHTML = analysis.html;
          document.getElementById('bytecodeViewer').textContent = currentBytecode.slice(0, 2000) + '...';
        }
      }

      currentABI = abi;

      // Get basic info
      const contract = new ethers.Contract(address, currentABI, provider);
      
      let name = 'Unknown';
      let symbol = '';
      let decimals = '-';
      let totalSupply = '-';

      try { name = await contract.name(); } catch {}
      try { symbol = await contract.symbol(); } catch {}
      try { decimals = (await contract.decimals()).toString(); } catch {}
      try { 
        const supply = await contract.totalSupply();
        totalSupply = formatLargeNumber(supply, parseInt(decimals) || 18);
      } catch {}

      // If not already detected as Dysnomia, try to detect type anyway
      if (!isDysnomia) {
        try {
          const type = await contract.Type();
          contractType = type;
        } catch {}
      }

      document.getElementById('contractName').textContent = name || Object.keys(KNOWN_CONTRACTS).find(k => KNOWN_CONTRACTS[k].toLowerCase() === address.toLowerCase()) || address.slice(0, 10);
      document.getElementById('contractType').textContent = contractType;
      document.getElementById('contractSupply').textContent = totalSupply;
      document.getElementById('contractDecimals').textContent = decimals;

      // Populate function list
      populateFunctionList(currentABI);

      // Add to recent
      addToRecent(address, name || address.slice(0, 10), contractType);

      // Update output with Dysnomia-specific info if applicable
      let outputText = `Contract loaded: ${name} (${symbol})\nAddress: ${address}\nType: ${contractType}\nVerified: ${verified ? 'Yes' : 'No'}`;
      
      if (isDysnomia) {
        outputText += `\n\nâš¡ DYSNOMIA CONTRACT\nUsing built-in ${contractType} ABI`;
        try {
          const xiao = await contract.Xiao();
          outputText += `\nXiao: ${xiao}`;
        } catch {}
        try {
          const maxSupply = await contract.maxSupply();
          outputText += `\nMax Supply: ${formatLargeNumber(maxSupply, parseInt(decimals) || 18)}`;
        } catch {}
        
        // Type-specific info
        if (contractType === 'LAU') {
          try { outputText += `\nUsername: ${await contract.Username()}`; } catch {}
          try { outputText += `\nEta (VOID): ${await contract.Eta()}`; } catch {}
        } else if (contractType === 'ZHOU') {
          try { outputText += `\nXi: ${(await contract.Xi()).toString()}`; } catch {}
          try { outputText += `\nMonopole: ${(await contract.Monopole()).toString()}`; } catch {}
          try { outputText += `\nUpsilon: ${await contract.Upsilon()}`; } catch {}
        } else if (contractType === 'ZHENG') {
          try { outputText += `\nEta: ${await contract.Eta()}`; } catch {}
        } else if (contractType === 'VOID') {
          try { outputText += `\nNu: ${await contract.Nu()}`; } catch {}
        } else if (contractType === 'QING') {
          try { outputText += `\nWaat: ${(await contract.Waat()).toString()}`; } catch {}
          try { outputText += `\nEntropy: ${(await contract.Entropy()).toString()}`; } catch {}
        } else if (contractType === 'CHO') {
          try { outputText += `\nEntropy: ${(await contract.Entropy()).toString()}`; } catch {}
          try { outputText += `\nVoid: ${await contract.Void()}`; } catch {}
        } else if (contractType === 'SHIO') {
          try { outputText += `\nRod: ${await contract.Rod()}`; } catch {}
          try { outputText += `\nCone: ${await contract.Cone()}`; } catch {}
          try { outputText += `\nManifold: ${(await contract.Manifold()).toString()}`; } catch {}
        }
      }
      
      outputText += `\n\nFunctions: ${Array.isArray(currentABI) ? currentABI.filter(x => x.type === 'function' || typeof x === 'string').length : 0}`;
      setOutput(outputText);
      
      log('Loaded: ' + name + (isDysnomia ? ` (${contractType})` : ''), 'success');
    }

    async function fetchABI(address) {
      try {
        const url = `${PULSESCAN_API}?module=contract&action=getabi&address=${address}`;
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.status === '1' && data.result) {
          return JSON.parse(data.result);
        }
      } catch (e) {
        log('PulseScan fetch failed', 'error');
      }
      return null;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BYTECODE ANALYSIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function analyzesBytecode(bytecode) {
      const selectors = extractSelectors(bytecode);
      const identified = [];
      const unknown = [];

      for (const sel of selectors) {
        const known = KNOWN_SELECTORS[sel];
        if (known) {
          identified.push({ selector: sel, ...known, source: 'known' });
        } else {
          unknown.push(sel);
        }
      }

      // Build ABI
      const abi = identified.map(item => {
        const match = item.sig.match(/^(\w+)\((.*)\)$/);
        if (!match) return null;
        const [, name, params] = match;
        
        const inputs = params ? params.split(',').filter(p => p.trim()).map((p, i) => ({ 
          name: `arg${i}`, 
          type: p.trim() 
        })) : [];

        let outputs = [];
        if (item.returns) {
          outputs = [{ name: '', type: item.returns }];
        }

        return {
          type: 'function',
          name: name,
          inputs: inputs,
          outputs: outputs,
          stateMutability: item.view ? 'view' : 'nonpayable'
        };
      }).filter(Boolean);

      // Build HTML for selector display
      let html = '<div style="font-size: 12px;">';
      html += `<div style="margin-bottom: 12px; color: var(--text-secondary);">Found ${selectors.length} selectors, identified ${identified.length}</div>`;
      
      html += '<div style="display: grid; gap: 8px;">';
      identified.forEach(item => {
        html += `
          <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px;">
            <span style="font-family: 'JetBrains Mono', monospace; color: var(--accent-primary);">0x${item.selector}</span>
            <span style="color: var(--success);">âœ“</span>
            <span style="font-family: 'JetBrains Mono', monospace;">${item.sig}</span>
            <span class="function-badge ${item.view ? 'read' : 'write'}">${item.view ? 'READ' : 'WRITE'}</span>
          </div>
        `;
      });
      
      if (unknown.length > 0) {
        html += `<div style="margin-top: 12px; color: var(--warning);">Unknown selectors:</div>`;
        unknown.slice(0, 10).forEach(sel => {
          html += `
            <div style="display: flex; align-items: center; gap: 10px; padding: 8px 12px; background: var(--bg-primary); border-radius: 6px;">
              <span style="font-family: 'JetBrains Mono', monospace; color: var(--text-muted);">0x${sel}</span>
              <span style="color: var(--warning);">?</span>
            </div>
          `;
        });
      }
      html += '</div></div>';

      return { abi, identified, unknown, html };
    }

    function extractSelectors(bytecode) {
      const selectors = new Set();
      const hex = bytecode.slice(2);

      const isLikelyAscii = (hexStr) => {
        let asciiCount = 0;
        for (let i = 0; i < hexStr.length; i += 2) {
          const byte = parseInt(hexStr.substr(i, 2), 16);
          if ((byte >= 0x20 && byte <= 0x7E) || byte === 0x00) {
            asciiCount++;
          }
        }
        return asciiCount >= 3;
      };

      for (let i = 0; i < hex.length - 10; i += 2) {
        if (hex.substr(i, 2) === '63') {
          const sel = hex.substr(i + 2, 8);
          if (sel && 
              sel !== '00000000' && 
              sel !== 'ffffffff' &&
              !/^(.)\1{7}$/.test(sel) &&
              !isLikelyAscii(sel)) {
            selectors.add(sel);
          }
        }
      }
      return Array.from(selectors);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNCTION EXECUTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function populateFunctionList(abi) {
      const list = document.getElementById('functionList');
      list.innerHTML = '';

      // Use ethers Interface to parse both JSON and human-readable ABIs
      let iface;
      try {
        iface = new ethers.Interface(abi);
      } catch (e) {
        log('Failed to parse ABI: ' + e.message, 'error');
        return;
      }

      const functions = [];
      iface.forEachFunction(fn => {
        const isRead = fn.stateMutability === 'view' || fn.stateMutability === 'pure';
        functions.push({
          name: fn.name,
          inputs: fn.inputs,
          outputs: fn.outputs,
          stateMutability: fn.stateMutability,
          isRead: isRead,
          sig: `${fn.name}(${fn.inputs.map(i => i.type).join(', ')})`
        });
      });

      // Sort: reads first, then alphabetically
      functions.sort((a, b) => {
        if (a.isRead !== b.isRead) return a.isRead ? -1 : 1;
        return a.name.localeCompare(b.name);
      });

      functions.forEach(fn => {
        list.innerHTML += `
          <div class="function-item" onclick="selectFunction('${fn.name}')" data-type="${fn.isRead ? 'read' : 'write'}">
            <span class="function-badge ${fn.isRead ? 'read' : 'write'}">${fn.isRead ? 'READ' : 'WRITE'}</span>
            <span class="function-name">${fn.sig}</span>
          </div>
        `;
      });
    }

    function showFunctionTab(tab) {
      document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');

      document.querySelectorAll('.function-item').forEach(item => {
        if (tab === 'all') {
          item.style.display = 'flex';
        } else if (tab === 'read') {
          item.style.display = item.dataset.type === 'read' ? 'flex' : 'none';
        } else {
          item.style.display = item.dataset.type === 'write' ? 'flex' : 'none';
        }
      });
    }

    function selectFunction(fnName) {
      // Use ethers Interface to find the function
      let iface;
      try {
        iface = new ethers.Interface(currentABI);
      } catch (e) {
        log('Failed to parse ABI', 'error');
        return;
      }

      // Find the function
      let fn = null;
      iface.forEachFunction(f => {
        if (f.name === fnName) fn = f;
      });

      if (!fn) {
        log('Function not found: ' + fnName, 'error');
        return;
      }

      selectedFunction = fn;
      const isRead = fn.stateMutability === 'view' || fn.stateMutability === 'pure';
      
      document.getElementById('selectedFunction').innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
          <span class="function-badge ${isRead ? 'read' : 'write'}">${isRead ? 'READ' : 'WRITE'}</span>
          <span style="font-family: 'JetBrains Mono', monospace; font-size: 14px; font-weight: 500;">${fn.name}</span>
        </div>
      `;

      // Build param inputs
      const paramDiv = document.getElementById('paramInputs');
      paramDiv.innerHTML = '';

      if (fn.inputs.length === 0) {
        paramDiv.innerHTML = '<div style="color: var(--text-muted); font-size: 12px;">No parameters required</div>';
      } else {
        fn.inputs.forEach((input, i) => {
          paramDiv.innerHTML += `
            <div class="param-input">
              <label>${input.name || 'arg' + i}</label>
              <input type="text" class="input" id="param_${i}" placeholder="${input.type}">
              <span class="param-type">${input.type}</span>
            </div>
          `;
        });
      }

      // Update buttons
      document.getElementById('readBtn').style.display = isRead ? 'flex' : 'none';
      document.getElementById('writeBtn').style.display = isRead ? 'none' : 'flex';
    }

    async function executeFunction(isRead) {
      if (!selectedFunction || !currentAddress || !currentABI) {
        log('Select a function first', 'error');
        return;
      }

      // Gather params
      const args = [];
      for (let i = 0; i < selectedFunction.inputs.length; i++) {
        const value = document.getElementById(`param_${i}`).value.trim();
        args.push(value);
      }

      log(`Calling ${selectedFunction.name}(${args.join(', ')})...`, 'info');
      setOutput('Executing...');

      try {
        let result;

        if (isRead) {
          const contract = new ethers.Contract(currentAddress, currentABI, provider);
          result = await contract[selectedFunction.name](...args);
        } else {
          if (!signer) {
            await connectWallet();
            if (!signer) {
              throw new Error('Wallet not connected');
            }
          }
          const contract = new ethers.Contract(currentAddress, currentABI, signer);
          const tx = await contract[selectedFunction.name](...args);
          log('Tx sent: ' + tx.hash.slice(0, 16) + '...', 'success');
          setOutput(`Transaction sent!\n\nHash: ${tx.hash}\n\nWaiting for confirmation...`);
          const receipt = await tx.wait();
          result = { hash: tx.hash, blockNumber: receipt.blockNumber, status: 'confirmed' };
        }

        // Format result
        const formatted = formatResult(result);
        setOutput(`${selectedFunction.name}() Result:\n\n${formatted}`);
        log('Success', 'success');

      } catch (e) {
        log('Error: ' + e.message.slice(0, 50), 'error');
        setOutput(`Error:\n\n${e.message}`);
      }
    }

    function formatResult(result) {
      if (typeof result === 'bigint') {
        return result.toString();
      } else if (Array.isArray(result)) {
        return JSON.stringify(result.map(r => typeof r === 'bigint' ? r.toString() : r), null, 2);
      } else if (result && typeof result === 'object') {
        const obj = {};
        for (const key of Object.keys(result)) {
          if (isNaN(key)) {
            obj[key] = typeof result[key] === 'bigint' ? result[key].toString() : result[key];
          }
        }
        return JSON.stringify(obj, null, 2);
      }
      return String(result);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI INTEGRATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function openApiKeyModal() {
      document.getElementById('apiKeyModal').classList.add('active');
      
      // Set current provider toggle
      selectProvider(aiProvider);
      
      // Fill in existing keys
      if (apiKey) {
        document.getElementById('apiKeyInput').value = apiKey;
      }
      if (geminiKey) {
        document.getElementById('geminiKeyInput').value = geminiKey;
      }
    }

    function closeApiKeyModal() {
      document.getElementById('apiKeyModal').classList.remove('active');
    }

    function selectProvider(provider) {
      aiProvider = provider;
      
      // Update toggle UI
      document.getElementById('providerClaude').classList.toggle('active', provider === 'claude');
      document.getElementById('providerGemini').classList.toggle('active', provider === 'gemini');
      
      // Show/hide config sections
      document.getElementById('claudeConfig').style.display = provider === 'claude' ? 'block' : 'none';
      document.getElementById('geminiConfig').style.display = provider === 'gemini' ? 'block' : 'none';
    }

    function saveApiKey() {
      if (aiProvider === 'claude') {
        const key = document.getElementById('apiKeyInput').value.trim();
        if (key && key.startsWith('sk-ant-')) {
          apiKey = key;
          localStorage.setItem('entropyAI_apiKey', key);
          localStorage.setItem('entropyAI_provider', 'claude');
          updateAIConfigStatus();
          closeApiKeyModal();
          log('Claude API key saved', 'success');
        } else {
          alert('Invalid Anthropic API key. Should start with sk-ant-');
        }
      } else {
        const key = document.getElementById('geminiKeyInput').value.trim();
        if (key && key.startsWith('AIza')) {
          geminiKey = key;
          localStorage.setItem('entropyAI_geminiKey', key);
          localStorage.setItem('entropyAI_provider', 'gemini');
          updateAIConfigStatus();
          closeApiKeyModal();
          log('Gemini API key saved', 'success');
        } else {
          alert('Invalid Google AI API key. Should start with AIza...');
        }
      }
    }
    
    function clearAllApiKeys() {
      apiKey = null;
      geminiKey = null;
      localStorage.removeItem('entropyAI_apiKey');
      localStorage.removeItem('entropyAI_geminiKey');
      localStorage.removeItem('entropyAI_provider');
      aiProvider = 'claude';
      document.getElementById('apiKeyInput').value = '';
      document.getElementById('geminiKeyInput').value = '';
      updateAIConfigStatus();
      log('All API keys cleared', 'info');
    }

    function updateAIConfigStatus() {
      const hasKey = (aiProvider === 'claude' && apiKey) || (aiProvider === 'gemini' && geminiKey);
      const providerName = aiProvider === 'claude' ? 'Claude' : 'Gemini';
      
      document.getElementById('aiConfig').innerHTML = hasKey ? `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(34, 197, 94, 0.1); border: 1px solid var(--success); border-radius: 6px;">
          <span style="color: var(--success); font-size: 11px;">âœ“ ${providerName} configured</span>
          <button class="btn btn-secondary btn-sm" onclick="openApiKeyModal()" style="padding: 4px 10px; font-size: 10px;">Change</button>
        </div>
      ` : `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: var(--bg-tertiary); border-radius: 6px;">
          <span style="color: var(--text-muted); font-size: 11px;">API Key: Not configured</span>
          <button class="btn btn-secondary btn-sm" onclick="openApiKeyModal()" style="padding: 4px 10px; font-size: 10px;">Set Key</button>
        </div>
      `;
    }

    async function sendToAI() {
      const input = document.getElementById('aiInput').value.trim();
      if (!input) return;

      // Add user message
      addAIMessage(input, 'user');
      document.getElementById('aiInput').value = '';

      // Check if we have an API key for the selected provider
      const currentKey = aiProvider === 'claude' ? apiKey : geminiKey;
      if (!currentKey) {
        const context = buildContext();
        const prompt = `${context}\n\nUser question: ${input}`;
        navigator.clipboard.writeText(prompt);
        addAIMessage(`ğŸ“‹ No ${aiProvider === 'claude' ? 'Claude' : 'Gemini'} API key configured. I've copied a formatted prompt to your clipboard.`, 'assistant');
        return;
      }

      addAIMessage('<div class="loader"></div> Thinking...', 'assistant');

      try {
        const context = buildContext();
        let responseText;

        if (aiProvider === 'claude') {
          // Claude API via serverless function
          const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey
            },
            body: JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 4096,
              messages: [{
                role: 'user',
                content: `${context}\n\nUser question: ${input}`
              }]
            })
          });

          const data = await response.json();
          
          if (data.content && data.content[0]) {
            responseText = data.content[0].text;
          } else {
            throw new Error(data.error?.message || 'Unknown Claude error');
          }
        } else {
          // Gemini API (direct call)
          const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${geminiKey}`;
          
          // Build system prompt for Gemini (same Dysnomia knowledge)
          const systemPrompt = buildGeminiPrompt(context, input);
          
          const response = await fetch(geminiUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              contents: [{
                parts: [{ text: systemPrompt }]
              }],
              generationConfig: {
                maxOutputTokens: 4096
              }
            })
          });

          const data = await response.json();
          
          if (data.candidates && data.candidates[0]?.content?.parts?.[0]?.text) {
            responseText = data.candidates[0].content.parts[0].text;
          } else {
            throw new Error(data.error?.message || JSON.stringify(data));
          }
        }
        
        // Remove loading message
        const messages = document.getElementById('aiMessages');
        messages.removeChild(messages.lastChild);

        // Clean the response of suggestion syntax for display
        const cleanResponse = responseText
          .replace(/\{\{SUGGEST_NAVIGATE:\w+:[^}]+\}\}/g, '')
          .replace(/\{\{SUGGEST_LOAD:0x[a-fA-F0-9]+:[^}]+\}\}/g, '')
          .replace(/\{\{SUGGEST_READ:[^}]+\}\}/g, '')
          .replace(/\{\{SUGGEST_WRITE:[^}]+\}\}/g, '')
          .trim();
        
        addAIMessage(cleanResponse, 'assistant');
        
        // Process any suggestions and show action buttons
        const suggestions = processAISuggestions(responseText);
        if (suggestions.length > 0) {
          const buttonsHtml = createActionButtons(suggestions);
          // Append buttons to the last message
          const lastMsg = document.querySelector('.ai-messages .ai-message:last-child');
          if (lastMsg) {
            lastMsg.innerHTML += buttonsHtml;
          }
        }
      } catch (e) {
        const messages = document.getElementById('aiMessages');
        messages.removeChild(messages.lastChild);
        addAIMessage('Error: ' + e.message, 'assistant');
      }
    }
    
    function buildGeminiPrompt(context, input) {
      return `You are the Dysnomia AI Assistant - an expert guide for the Dysnomia mathematical smart contract ecosystem on PulseChain.

You can SUGGEST actions for the user to confirm. Use these formats:

{{SUGGEST_NAVIGATE:CONTRACT_NAME:short reason}} - Suggest loading a known contract
{{SUGGEST_LOAD:0x...:short reason}} - Suggest loading by address  
{{SUGGEST_READ:functionName(args):short reason}} - Suggest reading data
{{SUGGEST_WRITE:functionName(args):short reason}} - Suggest a write transaction

The user will see buttons to confirm. Examples:
"I can load SEI to help create your YUE. {{SUGGEST_NAVIGATE:SEI:Load SEI contract}}"
"Let me check your balance. {{SUGGEST_READ:balanceOf(0x...):Check balance}}"

RULES:
1. Always explain WHY before suggesting
2. Keep the "reason" part short (shows on button)
3. For writes, explain consequences first

=== DYSNOMIA ARCHITECTURE ===

MOTZKIN PRIME: 953467954114363

CORE CHAIN: VOID â†’ SIU â†’ YANG â†’ YAU â†’ ZHOU â†’ ZHENG â†’ YI â†’ SHIO

KEY CONTRACTS:
- VOID: 0x965B0d74591bF30327075A247C47dBf487dCff08
- CHEON: 0x3d23084cA3F40465553797b5138CFC456E61FB5D  
- SEI: 0x3dC54d46e030C42979f33C9992348a990acb6067
- CHO: 0xB6be11F0A788014C1F68C92F8D6CcC1AbF78F2aB
- MAP: 0xD3a7A95012Edd46Ea115c693B74c5e524b3DdA75

USER LAYER:
- LAU: User token with Saat[3] (pole, soul, aura)
- YUE: IOT bridge (created via SEI.Start)
- QING: Territory with Waat coordinate

${context}

User question: ${input}

Be helpful and suggest actions when appropriate. User confirms before execution.`;
    }

    function addAIMessage(content, role) {
      const messages = document.getElementById('aiMessages');
      const div = document.createElement('div');
      div.className = 'ai-message ' + role;
      div.innerHTML = content.replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre>$2</pre>').replace(/`([^`]+)`/g, '<code>$1</code>');
      messages.appendChild(div);
      messages.scrollTop = messages.scrollHeight;
    }

    function clearAIChat() {
      document.getElementById('aiMessages').innerHTML = `
        <div class="ai-message assistant">
          ğŸ”® Chat cleared! Ready for new questions.
          
I have deep knowledge of the Dysnomia ecosystem:
â€¢ Reactor system (SHA, SHIO, modExp64)
â€¢ Core chain and domain layers
â€¢ User contracts (LAU, YUE, QING)
â€¢ Terraforming and META.Beat()

Load a contract and ask me anything!
        </div>
      `;
      log('AI chat cleared', 'info');
    }

    function buildContext() {
      let context = '=== CURRENT ENTROPY AI STATE ===\n\n';
      
      // User's discovered contracts from "Load My Identity"
      if (userContracts.lau || userContracts.wallet) {
        context += `=== USER IDENTITY ===\n`;
        if (userContracts.wallet) context += `Wallet: ${userContracts.wallet}\n`;
        if (userContracts.lau) context += `LAU: ${userContracts.lau}\n`;
        if (userContracts.yue) context += `YUE: ${userContracts.yue}\n`;
        if (userContracts.currentArea) context += `Current QING: ${userContracts.currentArea}\n`;
        if (userContracts.qings && userContracts.qings.length > 0) context += `All QINGs: ${userContracts.qings.join(', ')}\n`;
        context += `Registered in CHO: ${userContracts.registered ? 'Yes' : 'No'}\n`;
        context += '\n';
      }
      
      // Include the Output Panel content (results from Load My Identity, etc.)
      const outputContent = document.getElementById('outputContent')?.textContent || '';
      if (outputContent && outputContent.length > 50 && !outputContent.includes('Enter a contract')) {
        context += `=== LAST LOOKUP RESULT ===\n${outputContent}\n\n`;
      }
      
      // Currently loaded contract
      if (currentAddress) {
        context += `=== LOADED CONTRACT ===\n`;
        context += `Address: ${currentAddress}\n`;
        context += `Name: ${document.getElementById('contractName').textContent}\n`;
        context += `Type: ${document.getElementById('contractType').textContent}\n`;
        context += `Verified: ${document.getElementById('contractVerified').textContent}\n`;
        
        if (currentABI) {
          const fns = currentABI.filter(x => x.type === 'function');
          const reads = fns.filter(f => f.stateMutability === 'view' || f.stateMutability === 'pure');
          const writes = fns.filter(f => f.stateMutability !== 'view' && f.stateMutability !== 'pure');
          
          context += `\nREAD FUNCTIONS (${reads.length}):\n`;
          reads.slice(0, 20).forEach(f => {
            context += `  ${f.name}(${f.inputs.map(i => i.type).join(', ')})${f.outputs?.length ? ' â†’ ' + f.outputs.map(o => o.type).join(', ') : ''}\n`;
          });
          if (reads.length > 20) context += `  ... and ${reads.length - 20} more\n`;
          
          context += `\nWRITE FUNCTIONS (${writes.length}):\n`;
          writes.slice(0, 15).forEach(f => {
            context += `  ${f.name}(${f.inputs.map(i => i.type).join(', ')})\n`;
          });
          if (writes.length > 15) context += `  ... and ${writes.length - 15} more\n`;
        }
      } else {
        context += `=== NO CONTRACT LOADED ===\n`;
        context += `User can load a contract or ask general Dysnomia questions.\n`;
      }
      
      // Connection status
      context += `\n=== CONNECTION ===\n`;
      context += `Wallet Connected: ${signer ? 'Yes' : 'No'}\n`;
      if (signer) {
        context += `Can execute write functions: Yes\n`;
      }
      
      // Available actions the AI can SUGGEST (user confirms)
      context += `\n=== AI SUGGESTED ACTIONS ===
You can SUGGEST actions for the user to confirm. Use these formats:

{{SUGGEST_NAVIGATE:CONTRACT_NAME:reason}} - Suggest loading a known contract
{{SUGGEST_LOAD:0x...:reason}} - Suggest loading a contract by address  
{{SUGGEST_READ:functionName(args):reason}} - Suggest reading data
{{SUGGEST_WRITE:functionName(args):reason}} - Suggest a write transaction

The user will see buttons to confirm or decline. Examples:

"To check your YUE status, I need to load the SEI contract. {{SUGGEST_NAVIGATE:SEI:Load SEI to check YUE creation}}"

"Let me check your current territory. {{SUGGEST_READ:CurrentArea():Check which QING you're in}}"

"To create your YUE, we need to call Start(). {{SUGGEST_WRITE:Start(0x..., 'name', 'SYM'):Create your YUE token}}"

RULES:
1. Always explain WHY you're suggesting an action
2. For write functions, explain gas costs and consequences
3. Wait for user confirmation before they execute
4. You can suggest multiple actions - user picks which to run
5. Keep the "reason" part short (it shows on the button)
`;
      
      return context;
    }
    
    // Pending actions waiting for user confirmation
    let pendingActions = [];
    
    // Process AI suggestions and create confirmation buttons
    function processAISuggestions(responseText) {
      const suggestions = [];
      
      // Find all suggestions
      const patterns = [
        { regex: /\{\{SUGGEST_NAVIGATE:(\w+):([^}]+)\}\}/g, type: 'navigate' },
        { regex: /\{\{SUGGEST_LOAD:(0x[a-fA-F0-9]{40}):([^}]+)\}\}/g, type: 'load' },
        { regex: /\{\{SUGGEST_READ:(\w+\([^)]*\)):([^}]+)\}\}/g, type: 'read' },
        { regex: /\{\{SUGGEST_WRITE:(\w+\([^)]*\)):([^}]+)\}\}/g, type: 'write' },
      ];
      
      for (const pattern of patterns) {
        let match;
        while ((match = pattern.regex.exec(responseText)) !== null) {
          suggestions.push({
            type: pattern.type,
            action: match[1],
            reason: match[2],
            id: `action_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`
          });
        }
      }
      
      return suggestions;
    }
    
    // Create HTML for action buttons
    function createActionButtons(suggestions) {
      if (suggestions.length === 0) return '';
      
      let html = '<div class="ai-action-buttons">';
      
      for (const suggestion of suggestions) {
        const icon = {
          'navigate': 'ğŸ“‚',
          'load': 'ğŸ“‚',
          'read': 'ğŸ“–',
          'write': 'âœï¸'
        }[suggestion.type];
        
        const btnClass = suggestion.type === 'write' ? 'action-btn write' : 'action-btn';
        
        html += `
          <button class="${btnClass}" onclick="executeAIAction('${suggestion.type}', '${suggestion.action.replace(/'/g, "\\'")}')">
            ${icon} ${suggestion.reason}
          </button>
        `;
      }
      
      html += '<button class="action-btn decline" onclick="declineActions()">âŒ No thanks</button>';
      html += '</div>';
      
      return html;
    }
    
    // Execute a confirmed action
    async function executeAIAction(type, action) {
      log(`Executing: ${type} - ${action}`, 'info');
      
      // Remove action buttons
      document.querySelectorAll('.ai-action-buttons').forEach(el => el.remove());
      
      try {
        switch (type) {
          case 'navigate':
            const address = KNOWN_CONTRACTS[action];
            if (address) {
              addAIMessage(`âœ… Loading ${action}...`, 'assistant');
              await loadContract(address);
              addAIMessage(`âœ… ${action} loaded! You can now see its functions in the middle panel.`, 'assistant');
            } else {
              addAIMessage(`âŒ Unknown contract: ${action}`, 'assistant');
            }
            break;
            
          case 'load':
            addAIMessage(`âœ… Loading contract ${action.slice(0,10)}...`, 'assistant');
            await loadContract(action);
            addAIMessage(`âœ… Contract loaded!`, 'assistant');
            break;
            
          case 'read':
            if (!currentContract) {
              addAIMessage(`âš ï¸ Please load a contract first.`, 'assistant');
              return;
            }
            
            // Parse function call
            const readMatch = action.match(/(\w+)\((.*)\)/);
            if (readMatch) {
              const fnName = readMatch[1];
              const argsStr = readMatch[2];
              const args = argsStr ? argsStr.split(',').map(a => a.trim().replace(/['"]/g, '')) : [];
              
              addAIMessage(`ğŸ“Š Calling ${fnName}()...`, 'assistant');
              const result = await currentContract[fnName](...args);
              const formatted = formatResult(result);
              addAIMessage(`ğŸ“Š **${fnName}()** result:\n\`\`\`\n${formatted}\n\`\`\``, 'assistant');
            }
            break;
            
          case 'write':
            if (!signer) {
              addAIMessage(`âš ï¸ Please connect your wallet first.`, 'assistant');
              return;
            }
            if (!currentContract) {
              addAIMessage(`âš ï¸ Please load a contract first.`, 'assistant');
              return;
            }
            
            // Parse function call
            const writeMatch = action.match(/(\w+)\((.*)\)/);
            if (writeMatch) {
              const fnName = writeMatch[1];
              const argsStr = writeMatch[2];
              const args = argsStr ? argsStr.split(',').map(a => a.trim().replace(/['"]/g, '')) : [];
              
              addAIMessage(`âœï¸ Preparing ${fnName}()... Please confirm in your wallet.`, 'assistant');
              
              const contractWithSigner = currentContract.connect(signer);
              const tx = await contractWithSigner[fnName](...args);
              
              addAIMessage(`â³ Transaction submitted: ${tx.hash.slice(0,10)}...`, 'assistant');
              
              const receipt = await tx.wait();
              addAIMessage(`âœ… Transaction confirmed!\nHash: ${tx.hash}\nBlock: ${receipt.blockNumber}`, 'assistant');
              log(`Transaction confirmed: ${tx.hash}`, 'success');
            }
            break;
        }
      } catch (e) {
        addAIMessage(`âŒ Error: ${e.message}`, 'assistant');
        log(`Action error: ${e.message}`, 'error');
      }
    }
    
    function declineActions() {
      document.querySelectorAll('.ai-action-buttons').forEach(el => el.remove());
      addAIMessage(`ğŸ‘ No problem! Let me know if you need anything else.`, 'assistant');
    }

    function quickAction(action) {
      let prompt = '';
      
      switch (action) {
        case 'guide':
          prompt = `Based on my current state (wallet, LAU, YUE, loaded contract), what should I do next in Dysnomia? Give me specific steps and the exact function calls with parameters.`;
          break;
        case 'explain':
          prompt = 'Explain what this contract does in the Dysnomia ecosystem, what its role is, and how it connects to other contracts.';
          break;
        case 'react':
          prompt = 'Explain how to call React() on this contract. What parameters do I need? What will happen? Show me the exact ethers.js code to execute it.';
          break;
        case 'math':
          prompt = 'Explain the mathematical operations in this contract - modExp64, XOR chains, MotzkinPrime, etc. How does the reactor math work? Show examples with actual numbers.';
          break;
        case 'terraform':
          prompt = 'Explain how this contract fits into the terraforming layers (Physics, Terra, Firma, Life). How do I use it to accumulate Hypobar/Epibar on my YUE? What are the steps?';
          break;
        case 'functions':
          prompt = 'List and explain the main functions of this contract, especially the Dysnomia-specific ones.';
          break;
        case 'unknown':
          prompt = 'Help me identify any unknown function selectors in this contract.';
          break;
        case 'decode':
          prompt = 'Analyze the bytecode and help me understand the contract structure.';
          break;
      }

      document.getElementById('aiInput').value = prompt;
      sendToAI();
    }

    function askClaudeAboutBytecode() {
      document.getElementById('aiInput').value = 'Analyze the bytecode of this contract and help identify any unknown functions or patterns.';
      sendToAI();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function log(msg, type = '') {
      const logEl = document.getElementById('activityLog');
      const time = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.innerHTML = `<span class="log-time">${time}</span><span class="log-msg">${msg}</span>`;
      logEl.insertBefore(entry, logEl.firstChild);
    }

    function setOutput(text) {
      document.getElementById('outputContent').textContent = text;
    }

    function copyOutput() {
      navigator.clipboard.writeText(document.getElementById('outputContent').textContent);
      log('Copied to clipboard', 'success');
    }

    function copyAddress() {
      navigator.clipboard.writeText(currentAddress);
      log('Address copied', 'success');
    }

    function viewOnScan() {
      window.open(`https://scan.pulsechain.com/address/${currentAddress}`, '_blank');
    }

    function formatLargeNumber(value, decimals = 18) {
      const num = Number(value) / Math.pow(10, decimals);
      if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    function addToRecent(address, name, type) {
      recentContracts = recentContracts.filter(c => c.address !== address);
      recentContracts.unshift({ address, name, type });
      recentContracts = recentContracts.slice(0, 5);
      localStorage.setItem('entropyAI_recent', JSON.stringify(recentContracts));
      updateRecentList();
    }

    function updateRecentList() {
      const list = document.getElementById('recentContracts');
      if (recentContracts.length === 0) {
        list.innerHTML = '<div class="contract-item" style="justify-content: center; color: var(--text-muted);">No recent contracts</div>';
        return;
      }
      
      list.innerHTML = '';
      recentContracts.forEach(c => {
        list.innerHTML += `
          <div class="contract-item" onclick="loadContract('${c.address}')">
            <div>
              <div class="contract-item-name">${c.name}</div>
              <div class="contract-item-addr">${c.address.slice(0, 8)}...${c.address.slice(-6)}</div>
            </div>
            <span class="contract-item-type">${c.type}</span>
          </div>
        `;
      });
    }

    // Initialize on load
    window.addEventListener('load', init);

    // Allow Enter key in AI input
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('aiInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          sendToAI();
        }
      });
    });
  </script>
</body>
</html>
