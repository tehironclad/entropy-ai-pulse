<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QING Map - Dysnomia Territory Visualizer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --bg-card: #16161f;
      --border-color: rgba(255, 255, 255, 0.08);
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }

    /* Header */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      height: 50px;
    }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon {
      width: 32px; height: 32px;
      background: var(--accent-gradient);
      border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
    }
    .logo-text {
      font-size: 18px; font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .btn {
      padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;
      cursor: pointer; border: none; display: flex; align-items: center; gap: 5px;
      text-decoration: none; transition: all 0.2s;
    }
    .btn-primary { background: var(--accent-gradient); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { border-color: var(--accent-primary); }

    /* Main Layout */
    .main-container {
      display: flex;
      height: calc(100vh - 50px);
      margin-top: 50px;
    }

    /* Sidebar */
    .sidebar {
      width: 320px;
      min-width: 320px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease, min-width 0.3s ease, width 0.3s ease;
      position: relative;
      z-index: 100;
    }
    .sidebar.collapsed {
      margin-left: -320px;
      min-width: 0;
      width: 0;
    }
    .sidebar-toggle {
      position: absolute;
      right: -36px;
      top: 10px;
      width: 32px; height: 32px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-left: none;
      border-radius: 0 6px 6px 0;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 14px;
      z-index: 101;
    }
    .sidebar-toggle:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    
    .sidebar-section { padding: 10px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    .sidebar-section h3 {
      font-size: 9px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;
    }
    
    /* Search */
    .search-container { position: relative; }
    .search-input {
      width: 100%;
      padding: 10px 12px 10px 36px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 13px;
    }
    .search-input:focus { outline: none; border-color: var(--accent-primary); }
    .search-icon {
      position: absolute;
      left: 12px; top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 14px;
    }
    
    /* Search Results Dropdown */
    .search-results {
      position: absolute;
      top: 100%;
      left: 0; right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-top: 4px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 200;
      display: none;
    }
    .search-results.visible { display: block; }
    .search-result-item {
      padding: 10px 12px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .search-result-item:last-child { border-bottom: none; }
    .search-result-item:hover { background: var(--bg-tertiary); }
    .search-result-name { font-size: 13px; font-weight: 500; }
    .search-result-cat { font-size: 10px; color: var(--text-muted); }
    .search-result-add {
      font-size: 18px; color: var(--accent-primary);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .search-result-item:hover .search-result-add { opacity: 1; }

    /* Categories */
    .categories { display: flex; flex-wrap: wrap; gap: 4px; }
    .category-btn {
      padding: 3px 8px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      font-size: 10px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    .category-btn:hover { border-color: var(--accent-primary); color: var(--text-primary); }
    .category-btn.active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: white;
    }
    .category-btn .count {
      font-size: 8px;
      opacity: 0.7;
      margin-left: 2px;
    }

    /* Stats */
    .stats-row {
      display: flex;
      gap: 6px;
    }
    .stat-box {
      flex: 1;
      background: var(--bg-tertiary);
      border-radius: 6px;
      padding: 6px;
      text-align: center;
    }
    .stat-value { font-size: 16px; font-weight: 700; color: var(--accent-primary); }
    .stat-label { font-size: 8px; color: var(--text-muted); text-transform: uppercase; }

    /* Active QINGs List */
    .qing-list { flex: 1; overflow-y: auto; padding: 8px; }
    .qing-item {
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .qing-item:hover { border-color: var(--accent-primary); }
    .qing-item.selected { border-color: var(--accent-primary); background: rgba(99,102,241,0.1); }
    .qing-item.member { border-left: 3px solid var(--success); }
    .qing-marker-dot {
      width: 12px; height: 12px;
      border-radius: 50%;
      background: var(--accent-gradient);
      flex-shrink: 0;
    }
    .qing-marker-dot.gwat { background: linear-gradient(135deg, var(--warning), var(--error)); }
    .qing-marker-dot.member { background: linear-gradient(135deg, var(--success), #16a34a); }
    .qing-info { flex: 1; min-width: 0; }
    .qing-name {
      font-size: 12px; font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .qing-coords { font-size: 10px; color: var(--text-muted); }
    .qing-remove {
      background: none; border: none;
      color: var(--text-muted);
      cursor: pointer; font-size: 14px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .qing-item:hover .qing-remove { opacity: 1; }
    .qing-remove:hover { color: var(--error); }

    .empty-state {
      text-align: center;
      padding: 30px 20px;
      color: var(--text-muted);
    }
    .empty-state-icon { font-size: 36px; margin-bottom: 10px; }
    .empty-state-text { font-size: 12px; }

    /* Map */
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; background: #1a1a2e; }
    
    .leaflet-container { background: #1a1a2e; font-family: 'Inter', sans-serif; }
    .leaflet-control-zoom a { background: var(--bg-card); color: var(--text-primary); border-color: var(--border-color); }
    .leaflet-control-zoom a:hover { background: var(--bg-tertiary); }
    .leaflet-control-attribution { background: rgba(0,0,0,0.7); color: var(--text-muted); font-size: 10px; }
    .leaflet-control-attribution a { color: var(--accent-primary); }
    .leaflet-popup-content-wrapper {
      background: var(--bg-card); color: var(--text-primary);
      border-radius: 10px; border: 1px solid var(--border-color);
    }
    .leaflet-popup-tip { background: var(--bg-card); }
    .leaflet-popup-content { margin: 12px; }

    /* Info Panel */
    .info-panel {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      min-width: 300px;
      max-width: 400px;
      z-index: 500;
      display: none;
    }
    .info-panel.visible { display: block; }
    .info-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .info-panel-title { font-weight: 600; font-size: 15px; color: var(--accent-primary); }
    .info-panel-close {
      background: none; border: none;
      color: var(--text-muted); cursor: pointer; font-size: 18px;
    }
    .info-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 4px 12px;
      font-size: 11px;
      margin-bottom: 12px;
    }
    .info-label { color: var(--text-muted); }
    .info-value { color: var(--text-primary); font-family: 'JetBrains Mono', monospace; }
    .info-actions { display: flex; gap: 8px; }
    .info-actions .btn { flex: 1; justify-content: center; font-size: 11px; }

    /* Legend */
    .map-legend {
      position: absolute;
      bottom: 20px;
      right: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      font-size: 10px;
      z-index: 500;
    }
    .legend-title { font-weight: 600; margin-bottom: 6px; color: var(--text-secondary); }
    .legend-item { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; border: 2px solid white; }
    .legend-dot.qing { background: var(--accent-primary); }
    .legend-dot.gwat { background: var(--warning); }
    .legend-dot.member { background: var(--success); }
    .legend-line { width: 16px; height: 2px; border-radius: 1px; }
    .legend-line.asset { background: var(--success); }
    .legend-line.proximity { background: var(--accent-secondary); opacity: 0.5; }
    .toggle-group { margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color); }
    .toggle-item { display: flex; align-items: center; gap: 5px; margin-bottom: 3px; cursor: pointer; }
    .toggle-item input { accent-color: var(--accent-primary); width: 12px; height: 12px; }

    /* Toast */
    .toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 2000; }
    .toast {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 8px; padding: 10px 14px; margin-top: 8px; font-size: 12px;
      animation: slideIn 0.3s ease;
    }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--error); }
    .toast.info { border-left: 3px solid var(--accent-primary); }
    @keyframes slideIn {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* Status */
    .status-bar {
      padding: 8px 12px;
      background: var(--bg-tertiary);
      font-size: 10px;
      color: var(--text-muted);
      display: flex;
      justify-content: space-between;
    }
    .status-dot {
      width: 6px; height: 6px; border-radius: 50%;
      display: inline-block; margin-right: 5px;
      background: var(--error);
    }
    .status-dot.connected { background: var(--success); }

    /* Sidebar Tabs */
    .sidebar-tabs { display: flex; border-bottom: 1px solid var(--border-color); }
    .sidebar-tab { flex: 1; padding: 10px 8px; text-align: center; font-size: 10px; font-weight: 500; color: var(--text-muted); cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
    .sidebar-tab:hover { color: var(--text-secondary); }
    .sidebar-tab.active { color: var(--accent-primary); border-bottom-color: var(--accent-primary); }
    .tab-panel { display: none; flex-direction: column; flex: 1; overflow: hidden; min-height: 0; }
    .tab-panel.active { display: flex; }

    /* Filters */
    .filter-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .filter-item { display: flex; align-items: center; gap: 4px; font-size: 10px; color: var(--text-secondary); cursor: pointer; }
    .filter-item input { accent-color: var(--accent-primary); }

    /* Journey Tab */
    .journey-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: var(--bg-card); border-radius: 6px; margin-bottom: 4px; position: relative; cursor: pointer; }
    .journey-item:hover { background: var(--bg-tertiary); }
    .journey-num { width: 20px; height: 20px; background: var(--accent-gradient); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; flex-shrink: 0; }
    .journey-connector { position: absolute; left: 17px; top: 28px; bottom: -4px; width: 2px; background: var(--border-color); }

    /* Create Panel */
    .create-panel { padding: 12px; }
    .create-panel .input-group { margin-bottom: 10px; }
    .create-panel .input-label { font-size: 10px; color: var(--text-muted); margin-bottom: 4px; display: block; }
    .create-panel .input { width: 100%; padding: 8px; background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 11px; }
    .create-panel .input:focus { outline: none; border-color: var(--accent-primary); }
    .coord-display { background: var(--bg-tertiary); padding: 10px; border-radius: 6px; font-family: 'JetBrains Mono', monospace; font-size: 10px; margin-bottom: 10px; }
    .coord-label { color: var(--text-muted); }
    .coord-value { color: var(--accent-primary); }

    /* Map Controls */
    .map-controls { position: absolute; top: 10px; right: 10px; display: flex; flex-direction: column; gap: 4px; z-index: 500; }
    .map-control-btn { width: 32px; height: 32px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: var(--text-secondary); font-size: 14px; transition: all 0.2s; }
    .map-control-btn:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .map-control-btn.active { background: var(--accent-primary); color: white; border-color: var(--accent-primary); }

    /* Entropy Legend */
    .entropy-legend { position: absolute; bottom: 80px; right: 10px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 6px; padding: 8px; font-size: 9px; z-index: 500; display: none; }
    .entropy-legend.visible { display: block; }
    .entropy-gradient { width: 80px; height: 8px; background: linear-gradient(to right, #1e40af, #3b82f6, #22c55e, #f59e0b, #ef4444); border-radius: 2px; margin: 4px 0; }
    .entropy-labels { display: flex; justify-content: space-between; color: var(--text-muted); }

    /* Hecke Overlay */
    .hecke-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; z-index: 400; display: none; }
    .hecke-overlay.visible { display: block; }

    /* Info badges */
    .info-badges { display: flex; gap: 4px; margin-top: 4px; }
    .info-badge { padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 500; }
    .info-badge.gwat { background: var(--warning); color: black; }
    .info-badge.member { background: var(--success); color: white; }
    .info-badge.visited { background: #3b82f6; color: white; }

    /* Entropy bar in info panel */
    .info-entropy-bar { height: 4px; background: var(--bg-tertiary); border-radius: 2px; overflow: hidden; margin-top: 4px; }
    .info-entropy-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon">üó∫Ô∏è</div>
      <span class="logo-text">QING Map</span>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn btn-secondary">‚ö° Entropy AI</a>
      <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
    </div>
  </header>

  <div class="main-container">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</div>
      
      <div class="sidebar-tabs">
        <div class="sidebar-tab active" onclick="switchTab('explore')">Explore</div>
        <div class="sidebar-tab" onclick="switchTab('journey')">Journey</div>
        <div class="sidebar-tab" onclick="switchTab('create')">Create</div>
      </div>

      <!-- EXPLORE TAB -->
      <div class="tab-panel active" id="tab-explore">
        <div class="sidebar-section">
          <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" class="search-input" id="searchInput" placeholder="Search QINGs..." oninput="handleSearch()" onfocus="showSearchResults()">
            <div class="search-results" id="searchResults"></div>
          </div>
        </div>

      <div class="sidebar-section">
        <h3>Categories</h3>
        <div class="categories" id="categories"></div>
      </div>

      <div class="sidebar-section">
        <h3>Filters</h3>
        <div class="filter-group">
          <label class="filter-item"><input type="checkbox" id="filterGwat" onchange="applyFilters()"> GWATs only</label>
          <label class="filter-item"><input type="checkbox" id="filterMember" onchange="applyFilters()"> My QINGs</label>
          <label class="filter-item"><input type="checkbox" id="filterVisited" onchange="applyFilters()"> Visited</label>
        </div>
      </div>

      <div class="sidebar-section">
        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-value" id="statOnMap">0</div>
            <div class="stat-label">On Map</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statTotal">186</div>
            <div class="stat-label">Available</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="statYours">-</div>
            <div class="stat-label">Yours</div>
          </div>
        </div>
      </div>

      <div class="sidebar-section" style="flex:1;display:flex;flex-direction:column;min-height:0;overflow:hidden;padding-bottom:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-shrink:0;">
          <h3 style="margin:0;">On Map</h3>
          <div style="display:flex;gap:4px;">
            <button class="btn btn-secondary" style="padding:2px 6px;font-size:9px;" onclick="loadAll()">All</button>
            <button class="btn btn-secondary" style="padding:2px 6px;font-size:9px;" onclick="clearMap()">Clear</button>
          </div>
        </div>
        <div class="qing-list" id="qingList" style="flex:1;overflow-y:auto;min-height:0;">
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-text">Search or select a category</div>
          </div>
        </div>
      </div>
      </div><!-- end tab-explore -->

      <!-- JOURNEY TAB -->
      <div class="tab-panel" id="tab-journey">
        <div class="sidebar-section">
          <h3>Your Dysnomia Journey</h3>
          <p style="font-size:10px;color:var(--text-muted);margin-bottom:10px;">Track your path through territories</p>
          <div id="journeyStats" style="display:none;">
            <div class="stats-row">
              <div class="stat-box"><div class="stat-value" id="journeyVisited">0</div><div class="stat-label">Visited</div></div>
              <div class="stat-box"><div class="stat-value" id="journeyMember">0</div><div class="stat-label">Member</div></div>
            </div>
          </div>
        </div>
        <div class="sidebar-section" style="flex:1;overflow-y:auto;" id="journeyList">
          <div class="empty-state"><div class="empty-state-icon">üëõ</div><div class="empty-state-text">Connect wallet to track journey</div></div>
        </div>
      </div>

      <!-- CREATE TAB -->
      <div class="tab-panel" id="tab-create">
        <div class="create-panel">
          <h3 style="font-size:11px;margin-bottom:10px;">Create QING at Location</h3>
          <p style="font-size:10px;color:var(--text-muted);margin-bottom:12px;">Click anywhere on the map to select coordinates.</p>
          <div class="coord-display">
            <div><span class="coord-label">Lat: </span><span class="coord-value" id="createLat">-</span></div>
            <div><span class="coord-label">Lon: </span><span class="coord-value" id="createLon">-</span></div>
            <div><span class="coord-label">Waat: </span><span class="coord-value" id="createWaat">(assigned by MAP)</span></div>
          </div>
          <div class="input-group">
            <label class="input-label">Asset Token Address</label>
            <input type="text" class="input" id="createAsset" placeholder="0x...">
          </div>
          <div class="input-group">
            <label class="input-label">Or Select Token</label>
            <select class="input" id="createAssetSelect" onchange="selectCreateAsset()">
              <option value="">-- Select --</option>
              <option value="0xCc78A0acDF847A2C1714D2A925bB4477df5d48a6">ATROPA</option>
              <option value="0x6B175474E89094C44Da98b954EedeAC495271d0F">DAI</option>
              <option value="0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48">USDC</option>
            </select>
          </div>
          <button class="btn btn-primary" style="width:100%;justify-content:center;margin-top:12px;" onclick="createQing()">üåç Create via MAP.New()</button>
          <p style="font-size:9px;color:var(--text-muted);margin-top:10px;">Requires wallet. Waat is assigned by MAP contract.</p>
        </div>
      </div>

      <div class="status-bar">
        <div><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting...</span></div>
        <div id="walletStatus">PulseChain</div>
      </div>
    </aside>

    <div class="map-container">
      <div id="map"></div>
      <div class="hecke-overlay" id="heckeOverlay"></div>

      <div class="map-controls">
        <button class="map-control-btn" id="btnHecke" onclick="toggleHeckeGrid()" title="Hecke Grid">üìê</button>
        <button class="map-control-btn" id="btnEntropy" onclick="toggleEntropyView()" title="Entropy Heatmap">üå°Ô∏è</button>
        <button class="map-control-btn active" id="btnConnections" onclick="toggleConnectionsBtn()" title="Connections">üîó</button>
        <button class="map-control-btn" id="btnFlow" onclick="toggleFlow()" title="Asset Flow">‚ú®</button>
        <button class="map-control-btn" id="btnJourney" onclick="toggleJourneyPath()" title="Your Path">üõ§Ô∏è</button>
      </div>

      <div class="entropy-legend" id="entropyLegend">
        <div style="font-weight:600;margin-bottom:4px;">Entropy</div>
        <div class="entropy-gradient"></div>
        <div class="entropy-labels"><span>Low</span><span>High</span></div>
      </div>

      <div class="map-legend">
        <div class="legend-title">Markers</div>
        <div class="legend-item"><div class="legend-dot qing"></div><span>QING</span></div>
        <div class="legend-item"><div class="legend-dot gwat"></div><span>GWAT</span></div>
        <div class="legend-item"><div class="legend-dot member"></div><span>Your QING</span></div>
        <div class="legend-title" style="margin-top:6px;">Lines</div>
        <div class="legend-item"><div class="legend-line asset"></div><span>Same Asset</span></div>
        <div class="legend-item"><div class="legend-line" style="background:#3b82f6;"></div><span>Your Path</span></div>
      </div>

      <div class="info-panel" id="infoPanel">
        <div class="info-panel-header">
          <div>
            <div class="info-panel-title" id="infoTitle">-</div>
            <div class="info-badges" id="infoBadges"></div>
          </div>
          <button class="info-panel-close" onclick="closePanel()">√ó</button>
        </div>
        <div class="info-grid">
          <span class="info-label">Address</span><span class="info-value" id="infoAddr">-</span>
          <span class="info-label">Waat</span><span class="info-value" id="infoWaat">-</span>
          <span class="info-label">Coords</span><span class="info-value" id="infoCoords">-</span>
          <span class="info-label">Entropy</span>
          <div>
            <span class="info-value" id="infoEntropy">-</span>
            <div class="info-entropy-bar"><div class="info-entropy-fill" id="infoEntropyBar"></div></div>
          </div>
        </div>
        <div class="info-actions">
          <a class="btn btn-secondary" id="infoExplorer" href="#" target="_blank">Explorer</a>
          <button class="btn btn-secondary" onclick="joinSelectedQing()">Join</button>
          <a class="btn btn-primary" id="infoEntropyAI" href="#">Entropy AI</a>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toasts"></div>

  <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CONFIG & DATA
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    const RPC = 'https://rpc.pulsechain.com';
    const HECKE = '0x29A924D9B0233026B9844f2aFeB202F1791D7593';
    const MAP_CONTRACT = '0xD3a7A95012Edd46Ea115c693B74c5e524b3DdA75';
    const HECKE_ABI = ['function Compliment(uint64) view returns (int64,int64)'];
    const MAP_ABI = ['function New(address) returns (address)', 'event NewQing(address,address,uint256)'];
    const QING_ABI = [
      'function Waat() view returns (uint256)',
      'function Asset() view returns (address)',
      'function Entropy() view returns (uint64)',
      'function GWAT() view returns (bool)',
      'function IsMember(address) view returns (bool)',
      'function Join(address)',
    ];

    // Categories with their QINGs
    const CATEGORIES = {
      'Stablecoins': {
        color: '#22c55e',
        qings: [
          '0x644aAbeAcd96938a7ea5910f0C5240d289B64cd1', // DAI
          '0xa1ddBBcAB4f62E7968Cc4Adbe8Ca0634EE509956', // USDC
          '0x4C74302e0C64d2F03CF93135ae1D70F3487Cd7ee', // USDT
          '0x693424A8A747823c4f682d9Bd2Aa59D3C1cFeE6a', // DAI from ETH
          '0x86be06EFBEbB6cbA9d2303c2175037DA66477794', // USDT from ETH
          '0x39e9e8edf016524757a8202856e366b1D25E0a12', // USDC from ETH
          '0x06a7935F7e9Dee9340948762a86B7A89BF634dd0', // USDP
        ]
      },
      'Wrapped': {
        color: '#f59e0b',
        qings: [
          '0x85E14Bb47B22cF82a805B424ce605eA025ca751e', // WBTC
          '0x8157A5AC755d70218683232b06d6062253104918', // WPLS
          '0x875360521d23456af5CF561BD0B1C1FdBf47C4cB', // WETH
          '0xeed783EdC584aA1E796f28e3a2B3E37e8C3393C7', // WBTC from ETH
          '0x900AE7e39d13F8D0dBC9bd6F2F117C144Efb489A', // HEX
        ]
      },
      'DeFi': {
        color: '#8b5cf6',
        qings: [
          '0xC5b901C1Fad5ef392E8812ab134B46D3BC1acf31', // Aave
          '0xCCd1fED551Fe2C34E0876509e323a4F430922B6D', // Balancer
          '0xe0E3928c901491339BFF312224D172AAaFe3D6d4', // Compound
          '0xea530865dbca4fa985a9881E746C3D3e84DbE745', // Curve
          '0x5949C6d1b226ad35b4E040a43E6d36ad4d3C99d5', // Lido
          '0xA3263C6d3F76979F7078345ae528Dce928Bdfd38', // Chainlink
          '0x2fDa4e4e39B2366b8505E6d5490Fb0feFb7e9AB1', // Sushi
          '0x4b3E90c711C4a6cB98BC742A9acd7f75793A02d6', // Uniswap
          '0x8975C4663045d5E92dF191D5441c42b4Fa613016', // stETH
          '0x12EdE01A1bB388Ff5be75c0C545fBA123fFe8AD3', // wstETH
        ]
      },
      'Dysnomia Core': {
        color: '#ef4444',
        qings: [
          '0xFB1D79843B4be8c9fc244F54ee965d051261bb4B', // AFFECTION
          '0x012b805D8FB0bb53c4E9189328006B9c6D56a44c', // Cho
          '0x58065d1351972D9358665602c967EA58c13DC744', // MAP
          '0x0A2f46d1D07EA169ACea81bdc6d73Ed0f5812634', // mariarahel
          '0x872739Df73Cad8eC87418Bc0B00Eb9925BbF6971', // libAtropaMath
          '0x83Ec6aCdfD04C7Fdc98403937f8a18f7A8cd8399', // LEGAL
          '0x015A15727d5B21F58B5aB56a86959A3B32849BA9', // Treasury Bill
          '0x1cE307593CbE3C13B2624Bc95Aa7D10C9FB335b1', // Teddy Bear
          '0x829f778b5857eCa60C4c44f187A92395f453b4Da', // POPPY
        ]
      },
      'Geographic': {
        color: '#06b6d4',
        qings: [
          '0xb0Ba7D36B7F0505879179ecE7401F24eB653c6E1', // Z√ºrich
          '0xD127839B83cBf537c29B7d268c135f745a0Da2E8', // Illinois
          '0x4c6fc9EF5f930B7B0a23978ec73f13d44CfdE82e', // Zagreb
          '0x8985267Bbfe0E8c4Da9F6eABbD3341dcD88E975d', // Vatican
          '0x7F326F7fD8E308337b9c94f198DC6742d5958752', // Greenland
          '0xA65aC1bF7e70f8545575C50F40c43f3c898389b4', // Cherokee
          '0xA67EFFBfA307C6C9c6EA63E39654b97a6D8a334B', // Kremlin
        ]
      },
      'Meme/Community': {
        color: '#ec4899',
        qings: [
          '0xe83852e0574765f5d4D1d314c1c63e98A8EfA2c0', // Doge
          '0xF2C4087a18781D5347d4905E86b087B1b9D6ba51', // SHIB
          '0x3eA1B5181543B8F793943e9503091D463c6b18C7', // BitTorrent
          '0xF2Efa194B5571e407790998b14ED82BceD2Be3B1', // ü¶ù
          '0xE4169cF239e2FDc6E6e4a3a6fA0a703058ce400b', // RatKing
          '0x81b74e9a2eaf3c024EcBB19Ee6d592363F206A1b', // Fatoshi
        ]
      },
    };

    // All 186 QINGs from crawler
    const ALL_QINGS = [
      {address: '0xD127839B83cBf537c29B7d268c135f745a0Da2E8', name: 'Illinois Coin QING'},
      {address: '0x1299bBac80F7038c19C20843f80608Bd80C14A74', name: 'MrStu QING'},
      {address: '0xE41165BFd2C38A682289B2783D1e6E2e39E3766a', name: 'Ozymandias QING'},
      {address: '0xbfaA31C5eab4FcB21FE7CAFCBbAcb35593594589', name: 'Heavenly Dragon QING'},
      {address: '0xD0ccBB3e2aaD138c4e7e8727887557823F3c296c', name: 'Prof. Oak QING'},
      {address: '0xF2Efa194B5571e407790998b14ED82BceD2Be3B1', name: 'ü¶ù QING'},
      {address: '0xf628ddF33e97cfE53826E839241200E148394B16', name: 'Reserve Teh QING'},
      {address: '0x85E14Bb47B22cF82a805B424ce605eA025ca751e', name: 'Wrapped BTC QING'},
      {address: '0xF56A48A8Bff503D20745f2245ca1A208c870e787', name: 'LTDeFi QING'},
      {address: '0xb0Ba7D36B7F0505879179ecE7401F24eB653c6E1', name: 'Z√ºrich QING'},
      {address: '0xA43F71ac277022A547c56706fbBc5d93f88C3467', name: 'enter teh QING'},
      {address: '0x2245E41D46f6ebd511bc09e5330dda30FC19Ea18', name: 'Gokuldham Society QING'},
      {address: '0x5ae65A18c06011daab861106983CF72c153aD1fe', name: 'IronChad QING'},
      {address: '0x644aAbeAcd96938a7ea5910f0C5240d289B64cd1', name: 'Dai Stablecoin QING'},
      {address: '0x4D8a456a18aE141b04A983389409038Ea1FC709d', name: 'First Invocation Of ERIS QING'},
      {address: '0xa1ddBBcAB4f62E7968Cc4Adbe8Ca0634EE509956', name: 'USD Coin QING'},
      {address: '0x4C74302e0C64d2F03CF93135ae1D70F3487Cd7ee', name: 'Tether USD QING'},
      {address: '0xBc8fAAD427d17aE6AE386Bb073D3aD10B50EB91B', name: 'Eastern Lightning QING'},
      {address: '0x9CFAc9D4Db9A166D2c5aEE14b6aB796382a9eda8', name: 'Stay Of Proceedings QING'},
      {address: '0x6e1F57ece89aCdC669017Da539bAAC13c3d952D2', name: 'INDEPENDENCE QING'},
      {address: '0xCbFcA49631570387CB04577b82D55bE67b316c74', name: 'Teh QING'},
      {address: '0xeC9925a808DdFe4ebD283759489C03cbBa9DC181', name: 'Bo QING'},
      {address: '0x015A15727d5B21F58B5aB56a86959A3B32849BA9', name: 'TREASURY BILL QING'},
      {address: '0x83Ec6aCdfD04C7Fdc98403937f8a18f7A8cd8399', name: 'LEGAL QING'},
      {address: '0x1cE307593CbE3C13B2624Bc95Aa7D10C9FB335b1', name: 'Teddy Bear QING'},
      {address: '0x4DD0371C02631bfD17aD10aB7C0E35A047Ff2d20', name: 'Yat QING'},
      {address: '0xCaEa70828578eD9dC2D68d0aA1F3755EDc153385', name: 'BURR QING'},
      {address: '0x0A2f46d1D07EA169ACea81bdc6d73Ed0f5812634', name: 'mariarahel QING'},
      {address: '0xFB1D79843B4be8c9fc244F54ee965d051261bb4B', name: 'AFFECTION QING'},
      {address: '0x561854662DF671890b8fba538DEDbd2CDDCF7e32', name: 'PhD QING'},
      {address: '0x2554a08e8467701f826708095fbd968989fC1Da8', name: 'Monat QING'},
      {address: '0x872739Df73Cad8eC87418Bc0B00Eb9925BbF6971', name: 'libAtropaMath QING'},
      {address: '0xA55441e74CB64F9DE4a80183D435b05b30b0d9a2', name: 'Lillies QING'},
      {address: '0xeD65C29cc739402dB87B1BEFE12679402199d5d5', name: 'dOWN QING'},
      {address: '0x829f778b5857eCa60C4c44f187A92395f453b4Da', name: 'POPPY QING'},
      {address: '0xA65aC1bF7e70f8545575C50F40c43f3c898389b4', name: 'Cherokee QING'},
      {address: '0xbAae0aB51fF6c0Ea1Ed3Cc64F981B662f6a8113f', name: 'Buckingham QING'},
      {address: '0xa03d1569Bb76Fb23C0D2779866e6E80871D64B58', name: 'Wheel QING'},
      {address: '0xD70ACFbB2A88BFddC2e26f937A138616226552bc', name: 'United States Bank QING'},
      {address: '0xf398c7AEdD6aF9F357325D6E402503cbC45eE698', name: 'DH QING'},
      {address: '0xeB818b831DFdfeE90E3a036456dFeaa012fce9ef', name: 'Yogi QING'},
      {address: '0x776fdEd4E2fEDfA01cdE2930Bf703D2Fe48bAAE2', name: 'Not Exist QING'},
      {address: '0x6b1216d7c563d4a02D2CBE1A21655590a7F670D4', name: 'ACAB QING'},
      {address: '0x30057Be721FB94787Ad9c75Dc6648dd40c35eae2', name: 'MV QING'},
      {address: '0x8eA4aa2CD5d7E7B5d4F7F7aed7d23a406C12cE8e', name: 'Metis QING'},
      {address: '0x6f6A1b16F98C6c23eDCD05b0d34bf1F404a2cA3A', name: 'Hung QING'},
      {address: '0x903AaA437D8dd3122b362B5f339cd27a53865D2c', name: 'HOST QING'},
      {address: '0x8E52De27DC8E108F66EbbBeD5c47A024384647cB', name: 'Restraining Order QING'},
      {address: '0x23C8a89fA859023fF7c7F367df733af14e0719A5', name: 'GIMME FIVE QING'},
      {address: '0x1fb8D93f7D7d49A6F8892137838ADd45C48793D0', name: 'pINDEPENDENCE QING'},
      {address: '0x652ba47682c158673bE8784a9Aa9c125ea8715bb', name: 'Innit QING'},
      {address: '0xCeBcf3D363d6272B18F8708C9844E3c329C002C5', name: 'Knights Of Malta QING'},
      {address: '0x8089b25F1585C806Cc0d9c9Dc130665627b0b5dA', name: 'Phags-pa QING'},
      {address: '0xe840b6e56E269eB5b23bf3d1e6b7BBC9fE742C0c', name: 'Call QING'},
      {address: '0xC24c9E44B1dd1d0e5e9402D13163B3BcE47436a6', name: 'Emirates QING'},
      {address: '0x7F326F7fD8E308337b9c94f198DC6742d5958752', name: 'Greenland QING'},
      {address: '0x626337c72c8940B965AD48d503C3A7aE6AbD1a9d', name: 'Chicken Dinner QING'},
      {address: '0x9fDE2C9e2039C21461825d2504291e7A659a445a', name: 'winner QING'},
      {address: '0x6620d4400FF8803fC893a28BB4d69F7300127a3e', name: 'Tabor QING'},
      {address: '0x0835072E4F230E81a9c22155034DaD78D950CbCD', name: 'Mufti QING'},
      {address: '0xE0230d9803Bd212C71177A2e9a8BaFA54Dc70671', name: 'TRAEGER QING'},
      {address: '0xe8a7ddb2E302385b1d2c9dE1eA368023F3e6C115', name: 'Interview QING'},
      {address: '0xe5682B404850Bc83b8c6836cC6b730776833d104', name: 'Zuts aLARP QING'},
      {address: '0x0972C7CAe9857107200397ae1E20f21B59dA69c1', name: 'Large Comfy Chair QING'},
      {address: '0xAD7Cc51457dDae47dCcb55fDc10168Bc1B49C7Ee', name: 'Hegemony QING'},
      {address: '0x158F8e909d1eb4f7C165807899F1fACE6b76C12E', name: 'Bullion 8 QING'},
      {address: '0x4eB11Dcd373C3857E9544A0e6de956c65409F733', name: 'Basketball QING'},
      {address: '0xf426280a166Dc9797a906d513350a4429D1f765b', name: 'YouTube QING'},
      {address: '0x79F7F57F343DA5F3C6D282D837D3847c8A085B35', name: 'LT_OPS QING'},
      {address: '0x012b805D8FB0bb53c4E9189328006B9c6D56a44c', name: 'Dysnomia Cho QING'},
      {address: '0xDd0118DfFcCcC1Ce809b35B97A69Dcd56a4a4A04', name: 'minefullness QING'},
      {address: '0xc23219d2d454383Cd6b81bf6f21Fd058510e2D87', name: 'tests_for_toot QING'},
      {address: '0x2DAD80BCcd63ae144Aa84cE5cD110e24afd55fd7', name: 'PPluvYUE QING'},
      {address: '0xd11f6892E2D7dF8422fbA01680Ec8c7cd7d28457', name: 'PP4000 QING'},
      {address: '0x73f884b83303320872dDFf25Aab056E748597D89', name: 'chatlife QING'},
      {address: '0xD79fD2FfF5DaD1c330d757D16dc3283b8b4AC6F2', name: 'Greed QING'},
      {address: '0x902Fb3Ed4298F70b14c0Fb32FBF3e6f299C82AD3', name: '711 QING'},
      {address: '0x55c8Bb6E3B2EB74ff4E17894139F7e91d77Fee06', name: 'Lust QING'},
      {address: '0x10D0855f1Bb9D3A239a7953317CdD38419c93996', name: 'Syriac QING'},
      {address: '0xb45bd2D8728fF0cF320684Fbce79c27Bca036396', name: 'TEH G SOCIETY QING'},
      {address: '0xB9FBE2404fE67dC1498f90930c722E49FA9BA828', name: 'Palimpsest QING'},
      {address: '0x8d2c98F0E8071dc875d771Dd38aF5B3025Dc519c', name: 'Jabbie QING'},
      {address: '0x90b724bb34c6F6E629CaEfFb98B66B62f57D4450', name: 'Dark-Kamui QING'},
      {address: '0x2baA47C72D416553761D1dC74761ded7Dc89f38e', name: 'EhOneEh QING'},
      {address: '0x61C54CBabe5e4b64164E26FCD73De83556a4311e', name: 'oye mate QING'},
      {address: '0x6152e1b78a4f428BF26348B658E7107c6BcF747c', name: 'Grav QING'},
      {address: '0x4c6fc9EF5f930B7B0a23978ec73f13d44CfdE82e', name: 'Zagreb QING'},
      {address: '0x3c6047c8637A24FF2dBeCA1260190f1E1c5B1861', name: 'cLAUdia QING'},
      {address: '0x9fcA2363838960f75735AD35Ebc34D6F25afD164', name: 'HyperLight QING'},
      {address: '0x1F11e98298D93dA20CbC9b7acB7D93dcF1aC5E21', name: 'Terry Fox QING'},
      {address: '0x58065d1351972D9358665602c967EA58c13DC744', name: 'Dysnomia Map QING'},
      {address: '0x558FD2240D65B2cb72098444F5B888D8792cA8C5', name: 'PuffY QING'},
      {address: '0xbC1B23D5aa37fa3a7cBaA1b8967D7B2Dc28374A1', name: 'Richard Richard QING'},
      {address: '0x214BBeb1B93D476EC173833827A2DDCd40762fb7', name: 'PuffY 2 QING'},
      {address: '0xb91892D4D500551Fcb6408144a0bA0Eb9f00a042', name: 'KING STU QING'},
      {address: '0xE4169cF239e2FDc6E6e4a3a6fA0a703058ce400b', name: 'RatKing QING'},
      {address: '0x18eA4ACea0Be7DC27099291416e3E2Dba6380518', name: 'Pulse_spike QING'},
      {address: '0x3A3f249dB68a0df584A18098EcEcC5f6f0Ca3944', name: 'In The Know QING'},
      {address: '0x809F3EeCE0998FDD698ae41581BFA8c2e0411B78', name: 'cookies QING'},
      {address: '0x186dff4a427Cf5Eb82e087d9605C4e156266B851', name: 'WEB QING'},
      {address: '0x1CD36f0607FD28CA5C386F7fC9aC3032F9b19801', name: 'RH AKA MIKE QING'},
      {address: '0x5E97b5e8aD1621fe79a7dbedF890C6b03b085233', name: 'UPS QING'},
      {address: '0xd898C85C071128396Fb6082221d545cA01803ED5', name: 'NotsDotQ QING'},
      {address: '0x601F9a779b6f23814DF81698D72E13Eb017b413D', name: 'DotsNotnes QING'},
      {address: '0x8105962336bC3C7e7b662d41b3A20411c7CF7481', name: 'Ghydeon QING'},
      {address: '0x8B78D18751050b35045c4A65EdDa9909B2C1f819', name: 'Rosebud QING'},
      {address: '0xC56a3E96CB971be4119CDF3094ECD6B8bBb4f622', name: 'Koan QING'},
      {address: '0x49b63324b5288908989fCBE613A6fA5B988Fd9ad', name: 'Coexistence Steven QING'},
      {address: '0x923a2c6d923486eE4CB1D24f6f9ccAA702032ca5', name: 'Coexistence QING'},
      {address: '0x1B813252B66583487Cd2Af1dbb2F79F6944E462f', name: 'Spike spiegel QING'},
      {address: '0x6EE5FbcED6E7B5dF816Ff0502b90e97cb7Ae7D27', name: 'TRINITY QING'},
      {address: '0x2E20dE33b21A96Db0c6554155967Ba3701143D81', name: 'Joba QING'},
      {address: '0x33D7cA680f3dEd76414f82D9FFc0AD13e946a45D', name: 'Magi Port QING'},
      {address: '0x8D293A6728b76938d8f3ba8Ca4C3Ff5F70b059b1', name: 'X QING'},
      {address: '0xE3d57C5E482Ec49758218b09317986Fc7507777c', name: 'Baeffection QING'},
      {address: '0x92dFB0Ed3d95644784f9d428C65B642899D6914a', name: 'Sakura QING'},
      {address: '0x72eD037419aF06C07051420DDe440141232Cc886', name: 'IDEAL QING'},
      {address: '0xB9178657Dca756aCbB1DBC7885bD773947F74fF4', name: 'deZENtralization QING'},
      {address: '0x8Cf5f218113EA5c23ABedF58787dA58e4C8C91A6', name: 'Point Guards Coin QING'},
      {address: '0x43f5fb4B95a345B18Ee41961a83AF44e828983A3', name: 'Shield One QING'},
      {address: '0x12F094196783b993B86080bCfA48f7a96773427E', name: 'ppUSDT QING'},
      {address: '0x139298dbcCC50E837d8a23e3d77ED5A3150d78fd', name: 'ppFINAL QING'},
      {address: '0x32503EaF0009B15B85E3A35CAA7981045fdF5b2f', name: 'ppCROWS QING'},
      {address: '0x06e8e1250eb000ED1beD35e8106de0809154ae76', name: 'ppFINAL 2 QING'},
      {address: '0xd60186918acB0e2117869DAE864d8cde1D388E71', name: 'FREEBIES QING'},
      {address: '0x301bA124Be42A0e7a8f0D583c532Ad8d887065f9', name: 'LOAN QING'},
      {address: '0xE39690a43c3F979A413192A8cb5965602Fda826B', name: 'ppFREEBIES QING'},
      {address: '0x7343D8afA9d6e3376873eA24CCba7C7230aaB14B', name: 'ppLOAN QING'},
      {address: '0xF2a0636C05716CF4ce4937cb88348C8e2EcCf8E7', name: 'Aligned QING'},
      {address: '0xf8b9487137ac32C9F68c044B29b06705a4a6b836', name: 'CHATLOG Shio QING'},
      {address: '0x1661d42F37273F17c155fBF946c6dbC813fc8C21', name: 'Shadows of Triton QING'},
      {address: '0xFA767Ed66E6868E726c78E59B8AdC94732172f13', name: '4000 PPs QING'},
      {address: '0x66C76936fC07456b662346351c26948655934C3f', name: 'STARGAZER QING'},
      {address: '0x4226A7802FB3281D690134060bD36BF31854C57b', name: 'ydk5hundo QING'},
      {address: '0x81b74e9a2eaf3c024EcBB19Ee6d592363F206A1b', name: 'Fatoshi Snackamoto QING'},
      {address: '0x8157A5AC755d70218683232b06d6062253104918', name: 'Wrapped Pulse QING'},
      {address: '0x1e57aEdE4AFB1fAad4c6ad3da711fb26E7a44D00', name: 'Incentive QING'},
      {address: '0x875360521d23456af5CF561BD0B1C1FdBf47C4cB', name: 'Wrapped Ether QING'},
      {address: '0x693424A8A747823c4f682d9Bd2Aa59D3C1cFeE6a', name: 'Dai from Ethereum QING'},
      {address: '0x86be06EFBEbB6cbA9d2303c2175037DA66477794', name: 'Tether from Ethereum QING'},
      {address: '0x39e9e8edf016524757a8202856e366b1D25E0a12', name: 'USDC from Ethereum QING'},
      {address: '0xeed783EdC584aA1E796f28e3a2B3E37e8C3393C7', name: 'WBTC from Ethereum QING'},
      {address: '0x900AE7e39d13F8D0dBC9bd6F2F117C144Efb489A', name: 'HEX from Ethereum QING'},
      {address: '0x1EB1a9dc288cE4cf75B6Cd8E4525ad3f4f763f43', name: 'Gai QING'},
      {address: '0xAe584548961b80AdC3b3eCCbE4Fa37031725bF80', name: 'Tagalog QING'},
      {address: '0x73f2a2193abE85bA1290E08B04dcE1d64E91827B', name: 'Dreidel QING'},
      {address: '0x20eF620Ec63318A84Eb5Fe6010F6bb2a4F61ADe1', name: 'Reading QING'},
      {address: '0xB97fabD3588284F2848f804650092c0A47BDFEc2', name: 'LOL QING'},
      {address: '0xf9d9f7cD9D14C03a00410df7F4bE042Ae8dFD70a', name: 'Dampf QING'},
      {address: '0xa846857caD1153BC9cE3AD7391Dc7f1D060d2d75', name: 'GOD QING'},
      {address: '0x9a18D0ee9332e3357B99764936057265CCdf5Fb1', name: 'Tlingit QING'},
      {address: '0x008D99c30628D0B94be2076eB62c1E1d8A092048', name: 'SIM QING'},
      {address: '0x9FbcF0D8f908EDAc06e2922D199449A27F0904b1', name: 'Bin QING'},
      {address: '0x8909EcFCE761c8F15e8BA3c81c19Ae0213df58aB', name: 'Lillies 2 QING'},
      {address: '0xA67EFFBfA307C6C9c6EA63E39654b97a6D8a334B', name: 'Kremlin QING'},
      {address: '0x813663A7ED4B4b6001ae6e0CCfCf1d38CfF63AFa', name: 'Ze QING'},
      {address: '0x8985267Bbfe0E8c4Da9F6eABbD3341dcD88E975d', name: 'Vatican City QING'},
      {address: '0xac97AfF0C05Ef3840c991D9205F53Be80eF8F1f2', name: 'Frock QING'},
      {address: '0x41f9260B49faCb67Eb0072CB0F75094CD94E8b80', name: 'Buddhaghosa QING'},
      {address: '0x53B1c89fe423AFE3095662A253bd1b0776Eb40Ac', name: 'Rabbinical QING'},
      {address: '0xB33523015F92835B3D7d63CCC51fA0BB90507a96', name: 'WenTi QING'},
      {address: '0xe9F5EF3994FE76d83B0fAab75062e86457Ff96B9', name: '2 Cent Club QING'},
      {address: '0x04482c949F99177e53bEfe42bBC20E09bA317428', name: 'TRSI QING'},
      {address: '0x33F84D5f754C6BCdc55CaB4c712fff405895352b', name: 'PWA QING'},
      {address: '0xC5b901C1Fad5ef392E8812ab134B46D3BC1acf31', name: 'Aave Token QING'},
      {address: '0xCCd1fED551Fe2C34E0876509e323a4F430922B6D', name: 'Balancer QING'},
      {address: '0x3eA1B5181543B8F793943e9503091D463c6b18C7', name: 'BitTorrent QING'},
      {address: '0xe0E3928c901491339BFF312224D172AAaFe3D6d4', name: 'Compound Dai QING'},
      {address: '0xea530865dbca4fa985a9881E746C3D3e84DbE745', name: 'Curve DAO QING'},
      {address: '0xe83852e0574765f5d4D1d314c1c63e98A8EfA2c0', name: 'Dogecoin QING'},
      {address: '0x5949C6d1b226ad35b4E040a43E6d36ad4d3C99d5', name: 'Lido DAO QING'},
      {address: '0xA3263C6d3F76979F7078345ae528Dce928Bdfd38', name: 'ChainLink QING'},
      {address: '0x15EB61bc2EE18CAacCE042432ABfBA44F0760254', name: 'Paxos Gold QING'},
      {address: '0xF2C4087a18781D5347d4905E86b087B1b9D6ba51', name: 'SHIBA INU QING'},
      {address: '0xA1F27C6035783540d1f5F0a9163601E6233f9573', name: 'SAND QING'},
      {address: '0x8975C4663045d5E92dF191D5441c42b4Fa613016', name: 'Liquid staked Ether QING'},
      {address: '0x2fDa4e4e39B2366b8505E6d5490Fb0feFb7e9AB1', name: 'SushiToken QING'},
      {address: '0x4b3E90c711C4a6cB98BC742A9acd7f75793A02d6', name: 'Uniswap QING'},
      {address: '0x06a7935F7e9Dee9340948762a86B7A89BF634dd0', name: 'Pax Dollar QING'},
      {address: '0x12EdE01A1bB388Ff5be75c0C545fBA123fFe8AD3', name: 'wstETH QING'},
      {address: '0xf43D21F1eFD219B68FAd48005E63573EC8103BCC', name: 'Bonus QING'},
      {address: '0xB742345B9d59cB529145E9788110DDC1107469ED', name: 'Coast QING'},
      {address: '0x5de6076D5D5eA616f0D03a7F3BbCe0eA324dD69e', name: 'IRC QING'},
      {address: '0x67A8275cc8ca1eA4965b63e4c2F24dC5A0c882d4', name: 'Public Record QING'},
      {address: '0xfEbaB3FB779B7384eae9f76e48118660f34F0A7b', name: 'LIT QING'},
      {address: '0x6E43215F456627D7216e4c88CFcf126E733B4ECe', name: 'CiA QING'},
    ];

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    let provider, signer, map;
    let activeQings = [];
    let markers = {};
    let connectionLines = [];
    let journeyLines = [];
    let selected = null;
    let userAddress = null;
    let activeCategory = null;
    
    // View toggles
    let showHecke = false;
    let showEntropy = false;
    let showConnections = true;
    let showFlow = false;
    let showJourney = false;
    let flowInterval = null;
    
    // Create mode
    let createMode = false;
    let createCoords = null;

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // INIT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function init() {
      // Init map - full world view
      map = L.map('map', {
        center: [20, 0],
        zoom: 2,
        minZoom: 2,
        maxZoom: 18,
        worldCopyJump: true
      });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬©OSM ¬©CARTO',
        subdomains: 'abcd'
      }).addTo(map);

      // Map click handler for create mode
      map.on('click', onMapClick);

      // Connect RPC
      try {
        provider = new ethers.JsonRpcProvider(RPC);
        await provider.getNetwork();
        document.getElementById('statusDot').classList.add('connected');
        document.getElementById('statusText').textContent = 'Connected';
      } catch {
        document.getElementById('statusText').textContent = 'RPC Error';
      }

      // Render categories
      renderCategories();
      
      // Load saved QINGs from localStorage
      loadSavedQings();
      
      // Check for URL parameter to auto-load a QING
      const urlParams = new URLSearchParams(window.location.search);
      const qingParam = urlParams.get('qing');
      if (qingParam && ethers.isAddress(qingParam)) {
        await loadQingFromUrl(qingParam);
      }
      
      // Update stats
      document.getElementById('statTotal').textContent = ALL_QINGS.length;
      
      // Close search on outside click
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.search-container')) {
          document.getElementById('searchResults').classList.remove('visible');
        }
      });
    }

    // Load QING from URL parameter (cross-reference from Entropy AI)
    async function loadQingFromUrl(address) {
      // Check if already on map
      if (activeQings.find(q => q.address.toLowerCase() === address.toLowerCase())) {
        const existing = activeQings.find(q => q.address.toLowerCase() === address.toLowerCase());
        selectQing(existing.address);
        toast(`Focused on ${existing.name}`, 'info');
        return;
      }
      
      // Check if in our database
      let qingInfo = ALL_QINGS.find(q => q.address.toLowerCase() === address.toLowerCase());
      
      if (!qingInfo) {
        // Not in database, fetch name from chain
        try {
          const qing = new ethers.Contract(address, ['function name() view returns (string)'], provider);
          const name = await qing.name();
          qingInfo = { address, name: name || `QING ${address.slice(0,8)}...` };
        } catch {
          qingInfo = { address, name: `QING ${address.slice(0,8)}...` };
        }
      }
      
      toast(`Loading ${qingInfo.name} from Entropy AI...`, 'info');
      await addToMap(qingInfo);
      selectQing(address);
      toast(`‚úÖ ${qingInfo.name} loaded and selected!`, 'success');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SIDEBAR
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('collapsed');
      setTimeout(() => map.invalidateSize(), 300);
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CATEGORIES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function renderCategories() {
      const container = document.getElementById('categories');
      container.innerHTML = Object.entries(CATEGORIES).map(([name, cat]) => `
        <button class="category-btn" data-cat="${name}" onclick="toggleCategory('${name}')" style="border-color: ${cat.color}40">
          ${name}<span class="count">(${cat.qings.length})</span>
        </button>
      `).join('');
    }

    function toggleCategory(name) {
      const btn = document.querySelector(`[data-cat="${name}"]`);
      const cat = CATEGORIES[name];
      
      if (activeCategory === name) {
        // Remove category QINGs
        cat.qings.forEach(addr => removeFromMap(addr));
        btn.classList.remove('active');
        activeCategory = null;
      } else {
        // Clear previous category if any
        if (activeCategory) {
          document.querySelector(`[data-cat="${activeCategory}"]`)?.classList.remove('active');
        }
        // Add category QINGs
        cat.qings.forEach(addr => {
          const q = ALL_QINGS.find(x => x.address.toLowerCase() === addr.toLowerCase());
          if (q && !activeQings.find(x => x.address.toLowerCase() === addr.toLowerCase())) {
            addToMap(q);
          }
        });
        btn.classList.add('active');
        activeCategory = name;
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SEARCH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function handleSearch() {
      const query = document.getElementById('searchInput').value.toLowerCase().trim();
      const resultsDiv = document.getElementById('searchResults');
      
      if (!query) {
        resultsDiv.classList.remove('visible');
        return;
      }
      
      const matches = ALL_QINGS.filter(q => 
        q.name.toLowerCase().includes(query) ||
        q.address.toLowerCase().includes(query)
      ).slice(0, 10);
      
      if (matches.length === 0) {
        resultsDiv.innerHTML = '<div style="padding:12px;text-align:center;color:var(--text-muted);">No matches</div>';
      } else {
        resultsDiv.innerHTML = matches.map(q => {
          const cat = getCategoryForQing(q.address);
          const onMap = activeQings.find(x => x.address.toLowerCase() === q.address.toLowerCase());
          return `
            <div class="search-result-item" onclick="addFromSearch('${q.address}')">
              <div>
                <div class="search-result-name">${q.name}</div>
                <div class="search-result-cat">${cat || 'Community'}</div>
              </div>
              <span class="search-result-add">${onMap ? '‚úì' : '+'}</span>
            </div>
          `;
        }).join('');
      }
      resultsDiv.classList.add('visible');
    }

    function showSearchResults() {
      if (document.getElementById('searchInput').value.trim()) {
        handleSearch();
      }
    }

    function getCategoryForQing(addr) {
      for (const [name, cat] of Object.entries(CATEGORIES)) {
        if (cat.qings.some(a => a.toLowerCase() === addr.toLowerCase())) {
          return name;
        }
      }
      return null;
    }

    function addFromSearch(addr) {
      const q = ALL_QINGS.find(x => x.address.toLowerCase() === addr.toLowerCase());
      if (q && !activeQings.find(x => x.address.toLowerCase() === addr.toLowerCase())) {
        addToMap(q);
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').classList.remove('visible');
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MAP MANAGEMENT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function addToMap(qing) {
      // Fetch on-chain data
      const data = await fetchQingData(qing.address);
      const fullQing = { ...qing, ...data };
      
      activeQings.push(fullQing);
      saveQings();
      updateStats();
      renderList();
      renderMarkers();
    }

    function removeFromMap(addr) {
      activeQings = activeQings.filter(q => q.address.toLowerCase() !== addr.toLowerCase());
      if (selected?.address.toLowerCase() === addr.toLowerCase()) closePanel();
      saveQings();
      updateStats();
      renderList();
      renderMarkers();
    }

    function clearMap() {
      if (!confirm('Remove all QINGs from map?')) return;
      activeQings = [];
      selected = null;
      activeCategory = null;
      document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
      closePanel();
      saveQings();
      updateStats();
      renderList();
      renderMarkers();
    }

    async function fetchQingData(addr) {
      try {
        const qing = new ethers.Contract(addr, QING_ABI, provider);
        const hecke = new ethers.Contract(HECKE, HECKE_ABI, provider);
        
        let waat = 0n, lat = 0, lon = 0, isGwat = false, asset = null, entropy = 0n, isMember = false;
        
        try { waat = await qing.Waat(); } catch { waat = 0n; }
        try { asset = await qing.Asset(); } catch {}
        try { isGwat = await qing.GWAT(); } catch {}
        try { entropy = await qing.Entropy(); } catch {}
        if (userAddress) {
          try { isMember = await qing.IsMember(userAddress); } catch {}
        }
        
        try {
          const coords = await hecke.Compliment(waat);
          lon = Number(coords[0]) / 1e6;
          lat = Number(coords[1]) / 1e6;
        } catch {
          lat = Number(waat % 180n) - 90;
          lon = Number((waat / 180n) % 360n) - 180;
        }
        
        return { waat: waat.toString(), lat, lon, isGwat, asset, entropy: entropy.toString(), isMember, visited: false };
      } catch {
        return { waat: '0', lat: 0, lon: 0, isGwat: false, asset: null, entropy: '0', isMember: false, visited: false };
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // RENDERING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function renderList() {
      const list = document.getElementById('qingList');
      
      if (!activeQings.length) {
        list.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üîç</div>
            <div class="empty-state-text">Search or select a category to add QINGs</div>
          </div>
        `;
        return;
      }
      
      list.innerHTML = activeQings.map(q => `
        <div class="qing-item ${selected?.address === q.address ? 'selected' : ''} ${q.isMember ? 'member' : ''}" onclick="selectQing('${q.address}')">
          <div class="qing-marker-dot ${q.isGwat ? 'gwat' : ''} ${q.isMember ? 'member' : ''}"></div>
          <div class="qing-info">
            <div class="qing-name">${q.name}</div>
            <div class="qing-coords">${q.lat?.toFixed(2) || 0}¬∞, ${q.lon?.toFixed(2) || 0}¬∞</div>
          </div>
          <button class="qing-remove" onclick="event.stopPropagation();removeFromMap('${q.address}')">√ó</button>
        </div>
      `).join('');
    }

    function renderMarkers() {
      // Clear existing
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};

      const filtered = getFilteredQings();
      if (!filtered.length) return;

      filtered.forEach(q => {
        if (q.lat === undefined) return;
        
        let bgColor;
        if (showEntropy) {
          bgColor = getEntropyColor(q.entropy);
        } else if (q.isMember) {
          bgColor = '#22c55e';
        } else if (q.visited) {
          bgColor = '#3b82f6';
        } else if (q.isGwat) {
          bgColor = '#f59e0b';
        } else {
          bgColor = '#6366f1';
        }

        const size = q.isMember ? 16 : 12;
        const icon = L.divIcon({
          className: '',
          html: `<div style="width:${size}px;height:${size}px;background:${bgColor};border:2px solid white;border-radius:50%;box-shadow:0 2px 4px rgba(0,0,0,0.3);cursor:pointer;"></div>`,
          iconSize: [size, size],
          iconAnchor: [size/2, size/2]
        });

        const marker = L.marker([q.lat, q.lon], {icon})
          .addTo(map)
          .on('click', () => selectQing(q.address));

        marker.bindTooltip(q.name, {
          permanent: false,
          direction: 'top',
          offset: [0, -6]
        });

        markers[q.address] = marker;
      });

      // Fit bounds if we have markers
      if (filtered.length > 0) {
        const validQings = filtered.filter(q => q.lat !== undefined);
        if (validQings.length > 0) {
          const bounds = validQings.map(q => [q.lat, q.lon]);
          map.fitBounds(bounds, { padding: [50, 50], maxZoom: 6 });
        }
      }

      if (showConnections) renderConnections();
      if (showJourney) renderJourneyPath();
    }

    function renderConnections() {
      connectionLines.forEach(line => map.removeLayer(line));
      connectionLines = [];

      if (!showConnections) return;

      const filtered = getFilteredQings();
      // Draw lines between QINGs with same asset
      for (let i = 0; i < filtered.length; i++) {
        for (let j = i + 1; j < filtered.length; j++) {
          const q1 = filtered[i];
          const q2 = filtered[j];

          if (q1.asset && q2.asset &&
              q1.asset !== ethers.ZeroAddress &&
              q1.asset.toLowerCase() === q2.asset.toLowerCase() &&
              q1.lat !== undefined && q2.lat !== undefined) {
            const line = L.polyline([[q1.lat, q1.lon], [q2.lat, q2.lon]], {
              color: '#22c55e', weight: 2, opacity: 0.5
            }).addTo(map);
            line.bindTooltip('Same Asset', {sticky: true});
            connectionLines.push(line);
          }
        }
      }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // SELECTION & INFO PANEL
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function selectQing(addr) {
      const q = activeQings.find(x => x.address === addr);
      if (!q) return;
      
      selected = q;
      
      document.getElementById('infoTitle').textContent = q.name;
      
      // Badges
      let badges = '';
      if (q.isGwat) badges += '<span class="info-badge gwat">GWAT</span>';
      if (q.isMember) badges += '<span class="info-badge member">Member</span>';
      if (q.visited) badges += '<span class="info-badge visited">Visited</span>';
      document.getElementById('infoBadges').innerHTML = badges;
      
      document.getElementById('infoAddr').textContent = q.address.slice(0,10) + '...' + q.address.slice(-6);
      document.getElementById('infoWaat').textContent = q.waat?.slice(0, 16) + (q.waat?.length > 16 ? '...' : '');
      document.getElementById('infoCoords').textContent = `${q.lat?.toFixed(4)}¬∞, ${q.lon?.toFixed(4)}¬∞`;
      
      // Entropy
      const ePct = Math.min(100, Number(BigInt(q.entropy || 0) % 100n));
      document.getElementById('infoEntropy').textContent = ePct + '%';
      document.getElementById('infoEntropyBar').style.width = ePct + '%';
      document.getElementById('infoEntropyBar').style.background = getEntropyColor(q.entropy);
      
      document.getElementById('infoExplorer').href = 'https://scan.pulsechain.com/address/' + q.address;
      document.getElementById('infoEntropyAI').href = 'index.html?contract=' + q.address;
      
      document.getElementById('infoPanel').classList.add('visible');
      
      if (q.lat !== undefined) {
        map.panTo([q.lat, q.lon]);
      }
      
      renderList();
    }

    function closePanel() {
      selected = null;
      document.getElementById('infoPanel').classList.remove('visible');
      renderList();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // WALLET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    async function connectWallet() {
      if (!window.ethereum) return toast('Install MetaMask', 'error');
      try {
        const accts = await window.ethereum.request({method: 'eth_requestAccounts'});
        userAddress = accts[0];
        signer = new ethers.BrowserProvider(window.ethereum).getSigner();
        document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        document.getElementById('walletStatus').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        toast('Connected!', 'success');
        
        // Re-check memberships
        for (const q of activeQings) {
          try {
            const contract = new ethers.Contract(q.address, QING_ABI, provider);
            q.isMember = await contract.IsMember(userAddress);
          } catch { q.isMember = false; }
        }
        updateStats();
        renderList();
        renderMarkers();
        updateJourneyTab();
      } catch { toast('Connection failed', 'error'); }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // STORAGE & STATS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function saveQings() {
      localStorage.setItem('qingMapActive', JSON.stringify(activeQings.map(q => q.address)));
    }

    function loadSavedQings() {
      try {
        const saved = JSON.parse(localStorage.getItem('qingMapActive') || '[]');
        saved.forEach(addr => {
          const q = ALL_QINGS.find(x => x.address.toLowerCase() === addr.toLowerCase());
          if (q) addToMap(q);
        });
      } catch {}
    }

    function updateStats() {
      document.getElementById('statOnMap').textContent = activeQings.length;
      const memberCount = activeQings.filter(q => q.isMember).length;
      document.getElementById('statYours').textContent = userAddress ? memberCount : '-';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // UTILS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function toast(msg, type = 'info') {
      const t = document.createElement('div');
      t.className = 'toast ' + type;
      t.textContent = msg;
      document.getElementById('toasts').appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closePanel();
        document.getElementById('searchResults').classList.remove('visible');
      }
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // TABS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function switchTab(tab) {
      document.querySelectorAll('.sidebar-tab').forEach((t, i) => {
        t.classList.toggle('active', (tab === 'explore' && i === 0) || (tab === 'journey' && i === 1) || (tab === 'create' && i === 2));
      });
      document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
      document.getElementById('tab-' + tab).classList.add('active');
      createMode = tab === 'create';
      if (tab === 'journey') updateJourneyTab();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FILTERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function applyFilters() { renderList(); renderMarkers(); }
    
    function getFilteredQings() {
      let f = [...activeQings];
      if (document.getElementById('filterGwat')?.checked) f = f.filter(q => q.isGwat);
      if (document.getElementById('filterMember')?.checked) f = f.filter(q => q.isMember);
      if (document.getElementById('filterVisited')?.checked) f = f.filter(q => q.visited);
      return f;
    }

    async function loadAll() {
      toast('Loading all QINGs...', 'info');
      for (const q of ALL_QINGS) {
        if (!activeQings.find(x => x.address.toLowerCase() === q.address.toLowerCase())) {
          await addToMap(q);
        }
      }
      toast('Loaded ' + activeQings.length + ' QINGs', 'success');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // MAP CONTROL TOGGLES
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function toggleHeckeGrid() {
      showHecke = !showHecke;
      document.getElementById('btnHecke').classList.toggle('active', showHecke);
      document.getElementById('heckeOverlay').classList.toggle('visible', showHecke);
      if (showHecke) drawHeckeGrid();
    }

    function toggleEntropyView() {
      showEntropy = !showEntropy;
      document.getElementById('btnEntropy').classList.toggle('active', showEntropy);
      document.getElementById('entropyLegend').classList.toggle('visible', showEntropy);
      renderMarkers();
    }

    function toggleConnectionsBtn() {
      showConnections = !showConnections;
      document.getElementById('btnConnections').classList.toggle('active', showConnections);
      if (showConnections) renderConnections();
      else { connectionLines.forEach(l => map.removeLayer(l)); connectionLines = []; }
    }

    function toggleFlow() {
      showFlow = !showFlow;
      document.getElementById('btnFlow').classList.toggle('active', showFlow);
      if (showFlow) startFlowAnimation();
      else stopFlowAnimation();
    }

    function toggleJourneyPath() {
      showJourney = !showJourney;
      document.getElementById('btnJourney').classList.toggle('active', showJourney);
      if (showJourney) renderJourneyPath();
      else { journeyLines.forEach(l => map.removeLayer(l)); journeyLines = []; }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HECKE GRID
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function drawHeckeGrid() {
      const overlay = document.getElementById('heckeOverlay');
      let svg = '<svg width="100%" height="100%" style="position:absolute;top:0;left:0;">';
      for (let i = -180; i <= 180; i += 30) {
        const x = ((i + 180) / 360) * 100;
        svg += `<line x1="${x}%" y1="0" x2="${x}%" y2="100%" stroke="rgba(99,102,241,0.2)" stroke-width="1"/>`;
      }
      for (let i = -90; i <= 90; i += 30) {
        const y = ((90 - i) / 180) * 100;
        svg += `<line x1="0" y1="${y}%" x2="100%" y2="${y}%" stroke="rgba(99,102,241,0.2)" stroke-width="1"/>`;
      }
      svg += '</svg>';
      overlay.innerHTML = svg;
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ENTROPY COLORING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function getEntropyColor(entropy) {
      const e = Number(BigInt(entropy || 0) % 100n) / 100;
      if (e < 0.25) return '#1e40af';
      if (e < 0.5) return '#22c55e';
      if (e < 0.75) return '#f59e0b';
      return '#ef4444';
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // FLOW ANIMATION
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function startFlowAnimation() {
      if (flowInterval) return;
      flowInterval = setInterval(() => {
        connectionLines.forEach(line => {
          const op = line.options.opacity || 0.5;
          line.setStyle({ opacity: op === 0.5 ? 0.8 : 0.5 });
        });
      }, 500);
    }

    function stopFlowAnimation() {
      if (flowInterval) { clearInterval(flowInterval); flowInterval = null; }
      connectionLines.forEach(line => line.setStyle({ opacity: 0.5 }));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // JOURNEY PATH
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function renderJourneyPath() {
      journeyLines.forEach(l => map.removeLayer(l));
      journeyLines = [];
      if (!showJourney || !userAddress) return;
      const visited = activeQings.filter(q => q.visited || q.isMember);
      for (let i = 0; i < visited.length - 1; i++) {
        const a = visited[i], b = visited[i + 1];
        if (a.lat !== undefined && b.lat !== undefined) {
          const line = L.polyline([[a.lat, a.lon], [b.lat, b.lon]], { color: '#3b82f6', weight: 2, opacity: 0.7, dashArray: '5,5' }).addTo(map);
          journeyLines.push(line);
        }
      }
    }

    function updateJourneyTab() {
      if (!userAddress) {
        document.getElementById('journeyStats').style.display = 'none';
        document.getElementById('journeyList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üëõ</div><div class="empty-state-text">Connect wallet to track journey</div></div>';
        return;
      }
      const memberQings = activeQings.filter(q => q.isMember);
      const visitedQings = activeQings.filter(q => q.visited);
      document.getElementById('journeyStats').style.display = 'block';
      document.getElementById('journeyVisited').textContent = visitedQings.length;
      document.getElementById('journeyMember').textContent = memberQings.length;
      
      const all = [...memberQings, ...visitedQings.filter(v => !memberQings.find(m => m.address === v.address))];
      if (!all.length) {
        document.getElementById('journeyList').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üó∫Ô∏è</div><div class="empty-state-text">Join QINGs to start journey</div></div>';
        return;
      }
      document.getElementById('journeyList').innerHTML = all.map((q, i) => `
        <div class="journey-item" onclick="selectQing('${q.address}')">
          ${i < all.length - 1 ? '<div class="journey-connector"></div>' : ''}
          <div class="journey-num">${i + 1}</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:11px;font-weight:500;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${q.name}</div>
            <div style="font-size:9px;color:var(--text-muted);">${q.isMember ? '‚≠ê Member' : 'üëÅÔ∏è Visited'}</div>
          </div>
        </div>
      `).join('');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // CREATE QING
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    function onMapClick(e) {
      if (!createMode) return;
      createCoords = { lat: e.latlng.lat, lon: e.latlng.lng };
      document.getElementById('createLat').textContent = createCoords.lat.toFixed(6);
      document.getElementById('createLon').textContent = createCoords.lon.toFixed(6);
    }

    function selectCreateAsset() {
      const val = document.getElementById('createAssetSelect').value;
      if (val) document.getElementById('createAsset').value = val;
    }

    async function createQing() {
      const asset = document.getElementById('createAsset').value.trim();
      if (!asset || !ethers.isAddress(asset)) { toast('Enter valid asset address', 'error'); return; }
      if (!signer) { toast('Connect wallet first', 'error'); return; }
      try {
        toast('Creating QING...', 'info');
        const mapContract = new ethers.Contract(MAP_CONTRACT, MAP_ABI, await signer);
        const tx = await mapContract.New(asset);
        toast('Tx sent: ' + tx.hash.slice(0, 10) + '...', 'info');
        await tx.wait();
        toast('QING created!', 'success');
      } catch (e) { toast('Error: ' + (e.message || e).toString().slice(0, 50), 'error'); }
    }

    async function joinSelectedQing() {
      if (!selected || !signer) { toast('Connect wallet first', 'error'); return; }
      try {
        toast('Joining...', 'info');
        const q = new ethers.Contract(selected.address, QING_ABI, await signer);
        const tx = await q.Join(userAddress);
        await tx.wait();
        selected.isMember = true;
        toast('Joined ' + selected.name, 'success');
        renderList(); renderMarkers(); updateJourneyTab();
      } catch (e) { toast('Error: ' + (e.message || e).toString().slice(0, 40), 'error'); }
    }

    // Start
    init();
  </script>
</body>
</html>
