<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QING Map - Dysnomia Territory Visualizer</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-tertiary: #1a1a25;
      --bg-card: #16161f;
      --border-color: rgba(255, 255, 255, 0.08);
      --text-primary: #f0f0f5;
      --text-secondary: #a0a0b0;
      --text-muted: #606070;
      --accent-primary: #6366f1;
      --accent-secondary: #8b5cf6;
      --accent-gradient: linear-gradient(135deg, #6366f1, #8b5cf6);
      --success: #22c55e;
      --warning: #f59e0b;
      --error: #ef4444;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: fixed;
      top: 0; left: 0; right: 0;
      z-index: 1000;
      height: 60px;
    }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon {
      width: 36px; height: 36px;
      background: var(--accent-gradient);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }
    .logo-text {
      font-size: 20px; font-weight: 700;
      background: var(--accent-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header-actions { display: flex; gap: 12px; align-items: center; }
    .btn {
      padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 500;
      cursor: pointer; border: none; display: flex; align-items: center; gap: 6px;
      text-decoration: none; transition: all 0.2s;
    }
    .btn-primary { background: var(--accent-gradient); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-secondary { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); }
    .btn-secondary:hover { border-color: var(--accent-primary); }
    
    .main-container { display: flex; height: calc(100vh - 60px); margin-top: 60px; }
    
    .sidebar {
      width: 340px; background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      display: flex; flex-direction: column;
    }
    .sidebar-section { padding: 16px; border-bottom: 1px solid var(--border-color); }
    .sidebar-section h3 {
      font-size: 11px; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;
    }
    .input-group { display: flex; gap: 8px; }
    .input {
      flex: 1; padding: 10px 12px; background: var(--bg-tertiary);
      border: 1px solid var(--border-color); border-radius: 8px;
      color: var(--text-primary); font-size: 12px;
      font-family: 'JetBrains Mono', monospace;
    }
    .input:focus { outline: none; border-color: var(--accent-primary); }
    
    .qing-list { flex: 1; overflow-y: auto; padding: 8px; }
    .qing-item {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 10px; padding: 12px; margin-bottom: 8px;
      cursor: pointer; transition: all 0.2s;
    }
    .qing-item:hover { border-color: var(--accent-primary); }
    .qing-item.selected { border-color: var(--accent-primary); background: rgba(99,102,241,0.1); }
    .qing-item.member { border-left: 3px solid var(--success); }
    .qing-header { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .qing-name { font-weight: 600; font-size: 14px; }
    .qing-badge {
      font-size: 9px; padding: 2px 6px; border-radius: 4px;
      background: var(--warning); color: #000; margin-left: 6px;
    }
    .qing-remove { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 14px; }
    .qing-remove:hover { color: var(--error); }
    .qing-details { font-size: 11px; color: var(--text-secondary); font-family: 'JetBrains Mono', monospace; }
    .qing-coords {
      display: inline-block; margin-top: 6px; padding: 3px 8px;
      background: var(--bg-tertiary); border-radius: 4px;
      font-size: 11px; color: var(--accent-primary);
    }
    
    .status-bar {
      padding: 8px 16px; background: var(--bg-tertiary);
      border-top: 1px solid var(--border-color);
      font-size: 11px; color: var(--text-muted);
      display: flex; justify-content: space-between;
    }
    .status-dot {
      width: 8px; height: 8px; border-radius: 50%;
      display: inline-block; margin-right: 6px; background: var(--error);
    }
    .status-dot.connected { background: var(--success); }
    
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; background: #1a1a2e; }
    
    .leaflet-container { background: #1a1a2e; font-family: 'Inter', sans-serif; }
    .leaflet-control-zoom a { background: var(--bg-card); color: var(--text-primary); border-color: var(--border-color); }
    .leaflet-control-zoom a:hover { background: var(--bg-tertiary); }
    .leaflet-control-attribution { background: rgba(0,0,0,0.5); color: var(--text-muted); }
    .leaflet-control-attribution a { color: var(--accent-primary); }
    .leaflet-popup-content-wrapper {
      background: var(--bg-card); color: var(--text-primary);
      border-radius: 10px; border: 1px solid var(--border-color);
    }
    .leaflet-popup-tip { background: var(--bg-card); }
    
    .info-panel {
      position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 12px; padding: 16px 20px; min-width: 320px; z-index: 1000;
      display: none;
    }
    .info-panel.visible { display: block; }
    .info-panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .info-panel-title { font-weight: 600; font-size: 16px; color: var(--accent-primary); }
    .info-panel-close { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 20px; }
    .info-grid { display: grid; grid-template-columns: auto 1fr; gap: 6px 12px; font-size: 12px; margin-bottom: 12px; }
    .info-label { color: var(--text-muted); }
    .info-value { color: var(--text-primary); font-family: 'JetBrains Mono', monospace; word-break: break-all; }
    .info-actions { display: flex; gap: 8px; }
    .info-actions .btn { flex: 1; justify-content: center; }
    
    .empty-state { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
    
    .map-legend {
      position: absolute; top: 80px; right: 10px; z-index: 1000;
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 8px; padding: 12px; font-size: 11px;
    }
    .legend-title { font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
    .legend-item { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
    .legend-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; }
    .legend-dot.qing { background: var(--accent-primary); }
    .legend-dot.gwat { background: var(--warning); }
    .legend-line { width: 20px; height: 3px; border-radius: 2px; }
    .legend-line.asset { background: var(--success); }
    .legend-line.proximity { background: var(--accent-secondary); opacity: 0.5; }
    .toggle-group { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color); }
    .toggle-item { display: flex; align-items: center; gap: 6px; margin-bottom: 4px; cursor: pointer; }
    .toggle-item input { accent-color: var(--accent-primary); }
    
    .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 2000; }
    .toast {
      background: var(--bg-card); border: 1px solid var(--border-color);
      border-radius: 8px; padding: 12px 16px; margin-top: 8px; font-size: 13px;
    }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid var(--error); }
    .toast.info { border-left: 3px solid var(--accent-primary); }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon">üó∫Ô∏è</div>
      <span class="logo-text">QING Map</span>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn btn-secondary">‚ö° Entropy AI</a>
      <button class="btn btn-primary" id="connectBtn" onclick="connectWallet()">Connect Wallet</button>
    </div>
  </header>

  <div class="main-container">
    <aside class="sidebar">
      <div class="sidebar-section">
        <h3>Add QING</h3>
        <div class="input-group">
          <input type="text" class="input" id="qingInput" placeholder="0x... address">
          <button class="btn btn-primary" onclick="addQing()">Add</button>
        </div>
        <button class="btn btn-secondary" style="width:100%;margin-top:8px;justify-content:center;" onclick="scanForQings()" id="scanBtn">
          üîç Scan for QINGs
        </button>
      </div>
      <div class="sidebar-section">
        <h3>Search</h3>
        <input type="text" class="input" id="searchInput" placeholder="Search by name..." oninput="filterList()">
      </div>
      <div class="sidebar-section" style="padding:12px 16px;background:var(--bg-tertiary);">
        <div style="display:flex;justify-content:space-between;font-size:11px;">
          <span>Total QINGs:</span><span id="statTotal">0</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;">
          <span>GWATs:</span><span id="statGwats">0</span>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:11px;margin-top:4px;">
          <span>Your QINGs:</span><span id="statYours">-</span>
        </div>
      </div>
      <div class="sidebar-section" style="flex:1;display:flex;flex-direction:column;overflow:hidden;padding-bottom:0;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <h3 style="margin:0;">QINGs (<span id="qingCount">0</span>)</h3>
          <button class="btn btn-secondary" style="padding:4px 8px;font-size:10px;" onclick="clearAll()">Clear</button>
        </div>
        <div class="qing-list" id="qingList">
          <div class="empty-state">
            <div class="empty-state-icon">üìç</div>
            <div>No QINGs added</div>
          </div>
        </div>
      </div>
      <div class="status-bar">
        <div><span class="status-dot" id="statusDot"></span><span id="statusText">Connecting...</span></div>
        <div>PulseChain</div>
      </div>
    </aside>

    <div class="map-container">
      <div id="map"></div>
      
      <div class="map-legend">
        <div class="legend-title">Markers</div>
        <div class="legend-item"><div class="legend-dot qing"></div><span>QING</span></div>
        <div class="legend-item"><div class="legend-dot gwat"></div><span>GWAT</span></div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--success);"></div><span>Your QING</span></div>
        <div class="legend-title" style="margin-top:8px;">Connections</div>
        <div class="legend-item"><div class="legend-line asset"></div><span>Same Asset</span></div>
        <div class="legend-item"><div class="legend-line proximity"></div><span>Nearby</span></div>
        <div class="toggle-group">
          <label class="toggle-item"><input type="checkbox" id="showAsset" checked onchange="renderConnections()"> Asset Links</label>
          <label class="toggle-item"><input type="checkbox" id="showProximity" checked onchange="renderConnections()"> Proximity</label>
        </div>
      </div>

      <div class="info-panel" id="infoPanel">
        <div class="info-panel-header">
          <span class="info-panel-title" id="infoTitle">-</span>
          <button class="info-panel-close" onclick="closePanel()">√ó</button>
        </div>
        <div class="info-grid">
          <span class="info-label">Address</span><span class="info-value" id="infoAddr">-</span>
          <span class="info-label">Waat</span><span class="info-value" id="infoWaat">-</span>
          <span class="info-label">Coords</span><span class="info-value" id="infoCoords">-</span>
          <span class="info-label">Asset</span><span class="info-value" id="infoAsset">-</span>
          <span class="info-label">Entropy</span><span class="info-value" id="infoEntropy">-</span>
          <span class="info-label">Connections</span><span class="info-value" id="infoConnections">-</span>
        </div>
        <div class="info-actions">
          <a class="btn btn-secondary" id="infoExplorer" href="#" target="_blank">Explorer</a>
          <a class="btn btn-primary" id="infoEntropyAI" href="#">Entropy AI</a>
        </div>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toasts"></div>

  <script>
    const RPC = 'https://rpc.pulsechain.com';
    const CONTRACTS = {
      MAP: '0xD3a7A95012Edd46Ea115c693B74c5e524b3DdA75',
      HECKE: '0x29A924D9B0233026B9844f2aFeB202F1791D7593',
      CHO: '0xB6be11F0A788014C1F68C92F8D6CcC1AbF78F2aB',
    };
    const DEFAULTS = [
      {address:'0xb0Ba7D36B7F0505879179ecE7401F24eB653c6E1', name:'Z√ºrich'},
      {address:'0xD127839B83cBf537c29B7d268c135f745a0Da2E8', name:'Illinois'},
    ];
    const QING_ABI = [
      'function Waat() view returns (uint256)',
      'function Asset() view returns (address)',
      'function Entropy() view returns (uint64)',
      'function GWAT() view returns (bool)',
      'function name() view returns (string)',
      'function symbol() view returns (string)',
      'function GetMembers() view returns (address[])',
      'function IsMember(address) view returns (bool)',
    ];
    const MAP_ABI = [
      'function GetQing(uint256) view returns (address)',
      'function Offset() view returns (uint256)',
    ];
    const HECKE_ABI = ['function Compliment(uint64) view returns (int64,int64)'];

    let provider, map, cache = [], selected = null, userAddress = null;
    let markers = {}, connectionLines = [];
    let isScanning = false;

    async function init() {
      map = L.map('map', {
        center: [30, 0],
        zoom: 2,
        minZoom: 2,
        maxZoom: 18,
        worldCopyJump: true
      });

      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬©OpenStreetMap, ¬©CARTO',
        subdomains: 'abcd',
        maxZoom: 20
      }).addTo(map);

      try {
        provider = new ethers.JsonRpcProvider(RPC);
        await provider.getNetwork();
        document.getElementById('statusDot').classList.add('connected');
        document.getElementById('statusText').textContent = 'Connected';
      } catch {
        document.getElementById('statusText').textContent = 'RPC Error';
      }

      loadCache();
      if (!cache.length) {
        for (const d of DEFAULTS) await addByAddr(d.address, d.name);
      } else {
        updateStats();
        renderList();
        renderMarkers();
      }
    }

    async function connectWallet() {
      if (!window.ethereum) return toast('Install MetaMask', 'error');
      try {
        const accts = await window.ethereum.request({method: 'eth_requestAccounts'});
        userAddress = accts[0];
        document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
        toast('Connected', 'success');
        checkMemberships();
      } catch { toast('Failed', 'error'); }
    }

    async function checkMemberships() {
      if (!userAddress) {
        document.getElementById('statYours').textContent = '-';
        return;
      }
      let count = 0;
      for (const q of cache) {
        try {
          const contract = new ethers.Contract(q.address, QING_ABI, provider);
          const isMember = await contract.IsMember(userAddress);
          q.isMember = isMember;
          if (isMember) count++;
        } catch {
          q.isMember = false;
        }
      }
      document.getElementById('statYours').textContent = count;
      renderList();
      renderMarkers();
    }

    async function addQing() {
      const val = document.getElementById('qingInput').value.trim();
      if (!val || !ethers.isAddress(val)) return toast('Invalid address', 'error');
      if (cache.find(q => q.address.toLowerCase() === val.toLowerCase())) return toast('Already added', 'info');
      await addByAddr(val);
      document.getElementById('qingInput').value = '';
    }

    async function addByAddr(addr, name = null) {
      toast('Loading...', 'info');
      try {
        const q = new ethers.Contract(addr, QING_ABI, provider);
        const h = new ethers.Contract(CONTRACTS.HECKE, HECKE_ABI, provider);
        
        let waat, asset, entropy, gwat;
        try { name = name || await q.name(); } catch { name = 'QING ' + addr.slice(0,8); }
        try { waat = await q.Waat(); } catch { return toast('Not a QING', 'error'); }
        try { asset = await q.Asset(); } catch { asset = ethers.ZeroAddress; }
        try { entropy = await q.Entropy(); } catch { entropy = 0n; }
        try { gwat = await q.GWAT(); } catch { gwat = false; }
        
        let lat = 0, lon = 0;
        try {
          const c = await h.Compliment(waat);
          lat = Number(c[1]) / 1e6;
          lon = Number(c[0]) / 1e6;
        } catch {
          lat = Number(waat % 180n) - 90;
          lon = Number((waat / 180n) % 360n) - 180;
        }

        let isMember = false;
        if (userAddress) {
          try { isMember = await q.IsMember(userAddress); } catch {}
        }

        cache.push({address: addr, name, waat: waat.toString(), lat, lon, asset, entropy: entropy.toString(), gwat, isMember});
        saveCache();
        updateStats();
        renderList();
        renderMarkers();
        toast('Added ' + name, 'success');
      } catch(e) { toast(e.message, 'error'); }
    }

    async function scanForQings() {
      if (isScanning) return;
      isScanning = true;
      const btn = document.getElementById('scanBtn');
      btn.textContent = '‚è≥ Scanning...';
      btn.disabled = true;

      try {
        const mapContract = new ethers.Contract(CONTRACTS.MAP, MAP_ABI, provider);
        let found = 0;
        let index = 0;
        const maxScan = 100;

        while (index < maxScan) {
          try {
            const qingAddr = await mapContract.GetQing(index);
            if (!qingAddr || qingAddr === ethers.ZeroAddress || qingAddr === '0x0000000000000000000000000000000000000000') {
              break;
            }
            if (!cache.find(q => q.address.toLowerCase() === qingAddr.toLowerCase())) {
              await addByAddrSilent(qingAddr);
              found++;
            }
            index++;
          } catch {
            break;
          }
        }

        toast(`Found ${found} new QINGs`, 'success');
        updateStats();
        renderList();
        renderMarkers();
      } catch (e) {
        toast('Scan failed: ' + e.message, 'error');
      }

      btn.textContent = 'üîç Scan for QINGs';
      btn.disabled = false;
      isScanning = false;
    }

    async function addByAddrSilent(addr) {
      try {
        const q = new ethers.Contract(addr, QING_ABI, provider);
        const h = new ethers.Contract(CONTRACTS.HECKE, HECKE_ABI, provider);
        
        let name, waat, asset, entropy, gwat;
        try { name = await q.name(); } catch { name = 'QING ' + addr.slice(0,8); }
        try { waat = await q.Waat(); } catch { return; }
        try { asset = await q.Asset(); } catch { asset = ethers.ZeroAddress; }
        try { entropy = await q.Entropy(); } catch { entropy = 0n; }
        try { gwat = await q.GWAT(); } catch { gwat = false; }
        
        let lat = 0, lon = 0;
        try {
          const c = await h.Compliment(waat);
          lat = Number(c[1]) / 1e6;
          lon = Number(c[0]) / 1e6;
        } catch {
          lat = Number(waat % 180n) - 90;
          lon = Number((waat / 180n) % 360n) - 180;
        }

        let isMember = false;
        if (userAddress) {
          try { isMember = await q.IsMember(userAddress); } catch {}
        }

        cache.push({address: addr, name, waat: waat.toString(), lat, lon, asset, entropy: entropy.toString(), gwat, isMember});
        saveCache();
      } catch {}
    }

    function filterList() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      renderList(search);
    }

    function updateStats() {
      document.getElementById('statTotal').textContent = cache.length;
      document.getElementById('statGwats').textContent = cache.filter(q => q.gwat).length;
      const memberCount = cache.filter(q => q.isMember).length;
      document.getElementById('statYours').textContent = userAddress ? memberCount : '-';
    }

    function remove(addr) {
      cache = cache.filter(q => q.address.toLowerCase() !== addr.toLowerCase());
      saveCache();
      if (selected?.address.toLowerCase() === addr.toLowerCase()) closePanel();
      renderList();
      renderMarkers();
    }

    function clearAll() {
      if (!confirm('Clear all?')) return;
      cache = [];
      saveCache();
      closePanel();
      renderList();
      renderMarkers();
    }

    function renderList(filter = '') {
      const list = document.getElementById('qingList');
      const filtered = filter 
        ? cache.filter(q => q.name.toLowerCase().includes(filter) || q.address.toLowerCase().includes(filter))
        : cache;
      
      document.getElementById('qingCount').textContent = cache.length;
      
      if (!filtered.length) {
        list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üìç</div><div>${filter ? 'No matches' : 'No QINGs'}</div></div>`;
        return;
      }
      
      list.innerHTML = filtered.map(q => `
        <div class="qing-item ${selected?.address === q.address ? 'selected' : ''} ${q.isMember ? 'member' : ''}" onclick="selectQing('${q.address}')">
          <div class="qing-header">
            <span class="qing-name">
              ${q.isMember ? '‚≠ê ' : ''}${q.name}
              ${q.gwat ? '<span class="qing-badge">GWAT</span>' : ''}
            </span>
            <button class="qing-remove" onclick="event.stopPropagation();remove('${q.address}')">√ó</button>
          </div>
          <div class="qing-details">${q.address.slice(0,14)}...${q.address.slice(-6)}</div>
          <span class="qing-coords">üìç ${q.lat.toFixed(2)}¬∞, ${q.lon.toFixed(2)}¬∞</span>
        </div>
      `).join('');
    }

    function renderMarkers() {
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};

      if (!cache.length) return;

      cache.forEach(q => {
        // Different colors: GWAT=orange, Member=green, Regular=purple
        let bgColor = 'linear-gradient(135deg, #6366f1, #8b5cf6)';
        if (q.gwat) bgColor = 'linear-gradient(135deg, #f59e0b, #ef4444)';
        else if (q.isMember) bgColor = 'linear-gradient(135deg, #22c55e, #16a34a)';

        const icon = L.divIcon({
          className: '',
          html: `<div style="
            width: ${q.isMember ? '24px' : '20px'}; 
            height: ${q.isMember ? '24px' : '20px'};
            background: ${bgColor};
            border: ${q.isMember ? '3px' : '2px'} solid white;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          "></div>`,
          iconSize: [q.isMember ? 24 : 20, q.isMember ? 24 : 20],
          iconAnchor: [q.isMember ? 12 : 10, q.isMember ? 12 : 10]
        });

        const marker = L.marker([q.lat, q.lon], {icon})
          .addTo(map)
          .on('click', () => selectQing(q.address));

        marker.bindTooltip(q.name + (q.isMember ? ' ‚≠ê' : ''), {
          permanent: false,
          direction: 'top',
          offset: [0, -10]
        });

        markers[q.address] = marker;
      });

      if (cache.length > 0) {
        const bounds = cache.map(q => [q.lat, q.lon]);
        map.fitBounds(bounds, { padding: [50, 50], maxZoom: 4 });
      }

      renderConnections();
    }

    function renderConnections() {
      connectionLines.forEach(line => map.removeLayer(line));
      connectionLines = [];

      const showAsset = document.getElementById('showAsset').checked;
      const showProximity = document.getElementById('showProximity').checked;

      for (let i = 0; i < cache.length; i++) {
        for (let j = i + 1; j < cache.length; j++) {
          const q1 = cache[i];
          const q2 = cache[j];

          if (showAsset && q1.asset && q2.asset &&
              q1.asset !== ethers.ZeroAddress &&
              q1.asset.toLowerCase() === q2.asset.toLowerCase()) {
            const line = L.polyline([[q1.lat, q1.lon], [q2.lat, q2.lon]], {
              color: '#22c55e', weight: 3, opacity: 0.6
            }).addTo(map);
            line.bindTooltip('Same Asset', {sticky: true});
            connectionLines.push(line);
          }

          if (showProximity) {
            const dist = Math.sqrt(Math.pow(q1.lat - q2.lat, 2) + Math.pow(q1.lon - q2.lon, 2));
            if (dist < 30 && dist > 0) {
              const line = L.polyline([[q1.lat, q1.lon], [q2.lat, q2.lon]], {
                color: '#8b5cf6', weight: 1, opacity: 0.4, dashArray: '5,5'
              }).addTo(map);
              line.bindTooltip(`${dist.toFixed(1)}¬∞ apart`, {sticky: true});
              connectionLines.push(line);
            }
          }
        }
      }
    }

    function selectQing(addr) {
      const q = cache.find(x => x.address === addr);
      if (!q) return;
      
      selected = q;
      document.getElementById('infoTitle').innerHTML = q.name + (q.gwat ? ' <span class="qing-badge">GWAT</span>' : '');
      document.getElementById('infoAddr').textContent = q.address.slice(0,12) + '...' + q.address.slice(-6);
      document.getElementById('infoWaat').textContent = q.waat.length > 16 ? q.waat.slice(0,16) + '...' : q.waat;
      document.getElementById('infoCoords').textContent = q.lat.toFixed(4) + '¬∞, ' + q.lon.toFixed(4) + '¬∞';
      document.getElementById('infoAsset').textContent = q.asset.slice(0,12) + '...' + q.asset.slice(-6);
      document.getElementById('infoEntropy').textContent = q.entropy;

      const conns = findConnectionsFor(q);
      document.getElementById('infoConnections').innerHTML = conns.length > 0
        ? conns.map(c => `<span style="display:block;font-size:10px;">${c.type}: ${c.other.name}</span>`).join('')
        : 'None';

      document.getElementById('infoExplorer').href = 'https://scan.pulsechain.com/address/' + q.address;
      document.getElementById('infoEntropyAI').href = 'index.html?contract=' + q.address;
      document.getElementById('infoPanel').classList.add('visible');

      map.panTo([q.lat, q.lon]);
      renderList();
    }

    function findConnectionsFor(q) {
      const conns = [];
      cache.forEach(other => {
        if (other.address === q.address) return;
        if (q.asset && other.asset && q.asset !== ethers.ZeroAddress &&
            q.asset.toLowerCase() === other.asset.toLowerCase()) {
          conns.push({type: 'üîó Same Asset', other});
        }
        const dist = Math.sqrt(Math.pow(q.lat - other.lat, 2) + Math.pow(q.lon - other.lon, 2));
        if (dist < 30) conns.push({type: `üìç ${dist.toFixed(1)}¬∞`, other});
      });
      return conns;
    }

    function closePanel() {
      selected = null;
      document.getElementById('infoPanel').classList.remove('visible');
      renderList();
    }

    function saveCache() { localStorage.setItem('qingMap', JSON.stringify(cache)); }
    function loadCache() { try { cache = JSON.parse(localStorage.getItem('qingMap')) || []; } catch { cache = []; } }

    function toast(msg, type = 'info') {
      const t = document.createElement('div');
      t.className = 'toast ' + type;
      t.textContent = msg;
      document.getElementById('toasts').appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closePanel();
      if (e.key === 'Enter' && document.activeElement.id === 'qingInput') addQing();
    });

    init();
  </script>
</body>
</html>
